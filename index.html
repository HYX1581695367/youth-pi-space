<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>è£…å¤‡éƒ¨ä»¶å›¢æ”¯éƒ¨é’å¹´Ï€ç©ºé—´</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    
    <!-- Firebase SDK -->  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>  
    
    <!-- å¯†ç å“ˆå¸Œåº“ -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>  
    
    <!-- æ”¹è¿›çš„æ ·å¼ -->  
    <style>  
        .hidden {  
            display: none !important;  
        }  
        
        /* å¢å¼ºç§»åŠ¨ç«¯å›¾ç‰‡æ˜¾ç¤ºå…¼å®¹æ€§ */  
        @media (max-width: 768px) {  
            .post-image-container:not(.hidden) {  
                display: block !important;  
                width: 100% !important;  
                text-align: center !important;  
                margin-bottom: 1rem !important;  
            }  
            
            .post-image {  
                max-width: 100% !important;  
                height: auto !important;  
                max-height: 300px !important;  
                object-fit: contain !important;  
                display: inline-block !important;  
            }  
        }  
        
        /* ç§¯åˆ†æ’è¡Œæ¦œåŠ¨ç”» */  
        .rank-item {  
            transition: all 0.3s ease;  
        }  
        
        .rank-item:hover {  
            transform: translateX(5px);  
            background-color: #f0f9ff;  
        }  
        
        /* æ’åå¥–ç‰Œæ ·å¼ */  
        .rank-medal {  
            display: inline-flex;  
            align-items: center;  
            justify-content: center;  
            width: 32px;  
            height: 32px;  
            border-radius: 50%;  
            font-weight: bold;  
            font-size: 14px;  
        }  
        
        .rank-1 {  
            background: linear-gradient(135deg, #FFD700, #FFA500);  
            color: white;  
        }  
        
        .rank-2 {  
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);  
            color: white;  
        }  
        
        .rank-3 {  
            background: linear-gradient(135deg, #CD7F32, #B8860B);  
            color: white;  
        }  
        
        /* ç­¾åˆ°æŒ‰é’®åŠ¨ç”» */  
        .check-in-btn {  
            position: relative;  
            overflow: hidden;  
            transition: all 0.3s ease;  
        }  
        
        .check-in-btn:not(:disabled):hover {  
            transform: translateY(-2px);  
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);  
        }  
        
        .check-in-btn:disabled {  
            opacity: 0.6;  
            cursor: not-allowed;  
        }  
        
        /* ç­¾åˆ°æˆåŠŸåŠ¨ç”» */  
        @keyframes checkInSuccess {  
            0% { transform: scale(1); }  
            50% { transform: scale(1.1); }  
            100% { transform: scale(1); }  
        }  
        
        .check-in-success {  
            animation: checkInSuccess 0.5s ease;  
        }  
        
        /* è¿ç»­ç­¾åˆ°å¾½ç«  */  
        .streak-badge {  
            background: linear-gradient(135deg, #f59e0b, #ef4444);  
            color: white;  
            padding: 4px 12px;  
            border-radius: 12px;  
            font-size: 12px;  
            font-weight: bold;  
            display: inline-flex;  
            align-items: center;  
            gap: 4px;  
        }  
    </style>  
</head>  
<body class="bg-gray-100">  
    <div class="min-h-screen flex flex-col">  
        <!-- å¯¼èˆªæ  -->  
        <nav class="bg-blue-600 text-white shadow-lg">  
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">  
                <h1 class="text-2xl font-bold">è£…å¤‡éƒ¨ä»¶å›¢æ”¯éƒ¨é’å¹´Ï€ç©ºé—´</h1>  
                <div id="userNav" class="hidden">  
                    <div class="flex items-center space-x-3">  
                        <img id="navUserAvatar" class="w-8 h-8 rounded-full object-cover" src="https://via.placeholder.com/32" alt="ç”¨æˆ·å¤´åƒ">  
                        <span id="navUserName">åŠ è½½ä¸­...</span>  
                        <span id="navUserPoints" class="px-2 py-1 bg-yellow-400 text-blue-900 rounded font-bold text-sm">0ç§¯åˆ†</span>  
                        <!-- ç­¾åˆ°æŒ‰é’® -->  
                        <button id="checkInBtn" class="check-in-btn px-3 py-1 bg-green-500 rounded hover:bg-green-600 flex items-center gap-1">  
                            <span>ğŸ“…</span>  
                            <span id="checkInBtnText">ç­¾åˆ°</span>  
                        </button>  
                        <button id="editProfileBtn" class="px-3 py-1 bg-blue-500 rounded hover:bg-blue-600">ç¼–è¾‘ä¿¡æ¯</button>  
                        <!-- ç”¨æˆ·ç®¡ç†æŒ‰é’®ï¼ˆä»…ç³»ç»Ÿç®¡ç†å‘˜å¯è§ï¼‰ -->  
                        <button id="userManagementBtn" class="hidden px-3 py-1 bg-purple-500 rounded hover:bg-purple-600">ç”¨æˆ·ç®¡ç†</button>  
                        <!-- ç®¡ç†å‘˜è®¾ç½®æŒ‰é’®ï¼ˆæ‰€æœ‰ç®¡ç†å‘˜å¯è§ï¼‰ -->  
                        <button id="adminPanelBtn" class="hidden px-3 py-1 bg-red-500 rounded hover:bg-red-600">ç®¡ç†è®¾ç½®</button>  
                        <button id="logoutBtn" class="px-3 py-1 bg-gray-500 rounded hover:bg-gray-600">é€€å‡ºç™»å½•</button>  
                    </div>  
                </div>  
            </div>  
        </nav>  

        <!-- ä¸»å†…å®¹åŒº -->  
        <div class="container mx-auto px-4 py-6 flex-grow">  
            <!-- ç™»å½•è¡¨å• -->  
            <div id="loginContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10">  
                <h2 class="text-xl font-semibold mb-4 text-center">ç™»å½•é’å¹´Ï€ç©ºé—´</h2>  
                <p class="text-gray-600 mb-6 text-center">è¯·è¾“å…¥æ‚¨çš„å·¥å·å’Œå¯†ç </p>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">å·¥å·</label>  
                        <input id="loginEmployeeId" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å·¥å·">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">å¯†ç </label>  
                        <input id="loginPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å¯†ç ">  
                    </div>  
                    <div class="flex justify-center">  
                        <button id="loginBtn" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">ç™»å½•</button>  
                    </div>  
                    <div class="text-center">  
                        <p class="text-gray-600">é¦–æ¬¡ä½¿ç”¨? <button id="showRegisterBtn" class="text-blue-500 hover:underline">æ³¨å†Œæ–°è´¦å·</button></p>  
                    </div>  
                </div>  
            </div>  

            <!-- æ³¨å†Œè¡¨å• -->  
            <div id="registerContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10 hidden">  
                <h2 class="text-xl font-semibold mb-4 text-center">æ³¨å†Œæ–°è´¦å·</h2>  
                <p class="text-gray-600 mb-6 text-center">é¦–æ¬¡ä½¿ç”¨å·¥å·éœ€è¦æ³¨å†Œ</p>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">å§“å</label>  
                        <input id="registerName" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å§“å">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">å·¥å·</label>  
                        <input id="registerEmployeeId" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å·¥å·">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">è®¾ç½®å¯†ç </label>  
                        <input id="registerPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è®¾ç½®å¯†ç ">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">ç¡®è®¤å¯†ç </label>  
                        <input id="confirmPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">å¤´åƒ</label>  
                        <input id="registerAvatar" type="file" accept="image/*" class="w-full">  
                    </div>  
                    <div class="flex justify-center">  
                        <button id="registerBtn" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">æ³¨å†Œè´¦å·</button>  
                    </div>  
                    <div class="text-center">  
                        <p class="text-gray-600">å·²æœ‰è´¦å·? <button id="showLoginBtn" class="text-blue-500 hover:underline">è¿”å›ç™»å½•</button></p>  
                    </div>  
                </div>  
            </div>  

            <!-- ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯è¡¨å• -->  
            <div id="userInfoContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10 hidden">  
                <h2 class="text-xl font-semibold mb-4 text-center">ç¼–è¾‘ä¸ªäººä¿¡æ¯</h2>  
                <p class="text-gray-600 mb-6 text-center">æ‚¨å¯ä»¥ä¿®æ”¹ä¸ªäººä¿¡æ¯</p>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">å§“å</label>  
                        <input id="userName" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥å§“å">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">å¤´åƒ</label>  
                        <input id="userAvatar" type="file" accept="image/*" class="w-full">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">ä¿®æ”¹å¯†ç  (ç•™ç©ºåˆ™ä¸ä¿®æ”¹)</label>  
                        <input id="newPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥æ–°å¯†ç ">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">ç¡®è®¤æ–°å¯†ç </label>  
                        <input id="confirmNewPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">  
                    </div>  
                    <div class="flex justify-center space-x-3">  
                        <button id="saveUserInfoBtn" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">ä¿å­˜ä¿®æ”¹</button>  
                        <button id="cancelEditBtn" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">å–æ¶ˆ</button>  
                    </div>  
                </div>  
            </div>  

            <!-- ç®¡ç†å‘˜é¢æ¿ -->  
            <div id="adminPanelContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10 hidden">  
                <h2 class="text-xl font-semibold mb-4 text-center">ç®¡ç†å‘˜è®¾ç½®</h2>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">æ·»åŠ ç®¡ç†å‘˜å·¥å·</label>  
                        <div class="flex">  
                            <input id="newAdminId" type="text" class="flex-grow px-4 py-2 border rounded-l focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥å·¥å·">  
                            <button id="addAdminBtn" class="px-4 py-2 bg-blue-500 text-white rounded-r hover:bg-blue-600">æ·»åŠ </button>  
                        </div>  
                    </div>  
                    <div>  
                        <h3 class="text-lg font-semibold mb-2">å½“å‰ç®¡ç†å‘˜åˆ—è¡¨</h3>  
                        <div id="adminList" class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded">  
                            <p class="text-gray-500 text-center">åŠ è½½ä¸­...</p>  
                        </div>  
                    </div>  
                    <div class="flex justify-center">  
                        <button id="closeAdminPanelBtn" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">å…³é—­</button>  
                    </div>  
                </div>  
            </div>  

            <!-- ç”¨æˆ·ç®¡ç†é¢æ¿ - ä»…ç³»ç»Ÿç®¡ç†å‘˜å¯è§ -->  
            <div id="userManagementContainer" class="bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto my-10 hidden">  
                <h2 class="text-xl font-semibold mb-4 text-center">ç”¨æˆ·ç®¡ç†</h2>  
                <div class="space-y-4">  
                    <div class="overflow-auto">  
                        <table class="min-w-full bg-white">  
                            <thead>  
                                <tr>  
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left">å·¥å·</th>  
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left">å§“å</th>  
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left">ç§¯åˆ†</th>  
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left">è¿ç»­ç­¾åˆ°</th>  
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left">æ³¨å†Œæ—¶é—´</th>  
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left">ç®¡ç†å‘˜</th>  
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-100 text-left">æ“ä½œ</th>  
                                </tr>  
                            </thead>  
                            <tbody id="userTable">  
                                <!-- ç”¨æˆ·æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->  
                            </tbody>  
                        </table>  
                    </div>  
                    <div class="flex justify-center">  
                        <button id="closeUserManagementBtn" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">å…³é—­</button>  
                    </div>  
                </div>  
            </div>  

            <!-- ä¸»è¦å†…å®¹åŒº -->  
            <div id="mainContainer" class="hidden">  
                <!-- æ¿å—å¯¼èˆª -->  
                <div class="bg-white shadow-md rounded-lg p-4 mb-6">  
                    <div class="flex space-x-4">  
                        <button data-section="tech" class="section-btn px-4 py-2 rounded bg-blue-500 text-white">æŠ€æœ¯é—®é¢˜æ¿å—</button>  
                        <button data-section="daily" class="section-btn px-4 py-2 rounded bg-gray-200">æ—¥å¸¸é—®é¢˜æ¿å—</button>  
                        <button data-section="ranking" class="section-btn px-4 py-2 rounded bg-gray-200">ç§¯åˆ†æ’è¡Œæ¦œ</button>  
                        <button data-section="user" class="section-btn px-4 py-2 rounded bg-gray-200">ç”¨æˆ·æ¿å—</button>  
                    </div>  
                </div>  

                <!-- æŠ€æœ¯é—®é¢˜æ¿å— -->  
                <div id="techSection" class="section-content">  
                    <h2 class="text-xl font-bold mb-4">æŠ€æœ¯é—®é¢˜æ¿å—</h2>  
                    <div class="post-form bg-white shadow-md rounded-lg p-4 mb-6">  
                        <textarea id="techPostContent" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" rows="3" placeholder="åˆ†äº«ä½ çš„æŠ€æœ¯é—®é¢˜..."></textarea>  
                        <div class="flex items-center mb-3">  
                            <label class="mr-2 text-gray-600">æ·»åŠ å›¾ç‰‡:</label>  
                            <input id="techPostImage" type="file" accept="image/*">  
                        </div>  
                        <div class="flex items-center justify-between">  
                            <button id="techPostBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">å‘å¸ƒ</button>  
                            <span class="text-sm text-gray-500">ğŸ’° å‘å¸–å¯è·å¾— 10 ç§¯åˆ†</span>  
                        </div>  
                    </div>  
                    <div id="techPosts" class="space-y-6"></div>  
                </div>  

                <!-- æ—¥å¸¸é—®é¢˜æ¿å— -->  
                <div id="dailySection" class="section-content hidden">  
                    <h2 class="text-xl font-bold mb-4">æ—¥å¸¸é—®é¢˜æ¿å—</h2>  
                    <div class="post-form bg-white shadow-md rounded-lg p-4 mb-6">  
                        <textarea id="dailyPostContent" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" rows="3" placeholder="åˆ†äº«ä½ çš„æ—¥å¸¸é—®é¢˜..."></textarea>  
                        <div class="flex items-center mb-3">  
                            <label class="mr-2 text-gray-600">æ·»åŠ å›¾ç‰‡:</label>  
                            <input id="dailyPostImage" type="file" accept="image/*">  
                        </div>  
                        <div class="flex items-center justify-between">  
                            <button id="dailyPostBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">å‘å¸ƒ</button>  
                            <span class="text-sm text-gray-500">ğŸ’° å‘å¸–å¯è·å¾— 10 ç§¯åˆ†</span>  
                        </div>  
                    </div>  
                    <div id="dailyPosts" class="space-y-6"></div>  
                </div>  

                <!-- ç§¯åˆ†æ’è¡Œæ¦œæ¿å— -->  
                <div id="rankingSection" class="section-content hidden">  
                    <h2 class="text-xl font-bold mb-4">ğŸ† ç§¯åˆ†æ’è¡Œæ¦œ</h2>  
                    <div class="bg-white shadow-md rounded-lg p-6">  
                        <div class="mb-4 text-center">  
                            <p class="text-gray-600">ğŸ“Š æ¯æ—¥ç­¾åˆ° +2åˆ† | å‘å¸– +10åˆ† | å›å¸– +5åˆ† | ä¼˜è´¨å¸–ç½®é¡¶ +5åˆ†</p>  
                        </div>  
                        <div id="rankingList" class="space-y-3">  
                            <p class="text-gray-500 text-center py-8">åŠ è½½ä¸­...</p>  
                        </div>  
                    </div>  
                </div>  

                <!-- ç”¨æˆ·æ¿å— -->  
                <div id="userSection" class="section-content hidden">  
                    <h2 class="text-xl font-bold mb-4">ä¸ªäººä¸­å¿ƒ</h2>  
                    <div class="bg-white shadow-md rounded-lg p-6 mb-6">  
                        <div class="flex items-center space-x-4 mb-6">  
                            <div class="relative group">  
                                <img id="profileAvatar" class="w-20 h-20 rounded-full object-cover" src="https://via.placeholder.com/80" alt="ç”¨æˆ·å¤´åƒ">  
                                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" id="changeAvatarBtn">  
                                    <span class="text-white text-xs">æ›´æ¢å¤´åƒ</span>  
                                </div>  
                                <input type="file" id="avatarInput" class="hidden" accept="image/*">  
                            </div>  
                            <div>  
                                <h3 id="profileName" class="text-xl font-semibold">åŠ è½½ä¸­...</h3>  
                                <p class="text-gray-600">å·¥å·: <span id="profileEmployeeId">åŠ è½½ä¸­...</span></p>  
                                <p class="text-yellow-600 font-bold text-lg">ğŸ’° ç§¯åˆ†: <span id="profilePoints">0</span></p>  
                                <!-- ç­¾åˆ°ä¿¡æ¯ -->  
                                <div class="mt-2">  
                                    <span id="checkInStreak" class="streak-badge">ğŸ”¥ è¿ç»­ç­¾åˆ° 0 å¤©</span>  
                                    <p id="lastCheckInTime" class="text-xs text-gray-500 mt-1">ä¸Šæ¬¡ç­¾åˆ°: æœªç­¾åˆ°</p>  
                                </div>  
                                <div class="flex space-x-2 mt-1">  
                                    <p id="adminBadge" class="hidden text-xs bg-red-500 text-white px-2 py-0.5 rounded inline-block">ç®¡ç†å‘˜</p>  
                                    <p id="systemAdminBadge" class="hidden text-xs bg-purple-500 text-white px-2 py-0.5 rounded inline-block">ç³»ç»Ÿç®¡ç†å‘˜</p>  
                                </div>  
                            </div>  
                        </div>  
                    </div>  

                    <h3 class="text-lg font-semibold mb-3">æˆ‘çš„å‘å¸ƒè®°å½•</h3>  
                    <div id="userPosts" class="space-y-6"></div>  
                </div>  
            </div>  
        </div>  
        
        <!-- é¡µè„š -->  
        <footer class="bg-gray-800 text-white py-4 mt-auto">  
            <div class="container mx-auto px-4 text-center">  
                <p>è£…å¤‡éƒ¨ä»¶å›¢æ”¯éƒ¨é’å¹´Ï€ç©ºé—´ &copy; 2025</p>  
            </div>  
        </footer>  
    </div>  

    <!-- çŠ¶æ€æç¤º -->  
    <div id="statusToast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-20 opacity-0">  
        æ“ä½œæˆåŠŸ  
    </div>  

    <!-- æ•°æ®åŠ è½½ä¸­é®ç½© -->  
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">  
        <div class="bg-white p-4 rounded-lg shadow-lg text-center">  
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-2"></div>  
            <p>åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</p>  
        </div>  
    </div>  

    <!-- æ¨¡æ¿ -->  
    <template id="postTemplate">  
        <div class="post bg-white shadow-md rounded-lg p-4">  
            <div class="flex items-start space-x-3 mb-3">  
                <img class="post-avatar w-10 h-10 rounded-full object-cover" src="https://via.placeholder.com/40" alt="ç”¨æˆ·å¤´åƒ">  
                <div class="flex-grow">  
                    <div class="flex items-center space-x-2">  
                        <h3 class="post-author font-semibold"></h3>  
                        <span class="post-admin-badge hidden text-xs bg-red-500 text-white px-1 rounded">ç®¡ç†å‘˜</span>  
                        <span class="post-pinned-badge hidden text-xs bg-yellow-500 text-white px-1 rounded">ç½®é¡¶</span>  
                    </div>  
                    <p class="post-time text-gray-500 text-sm"></p>  
                </div>  
            </div>  
            <p class="post-content mb-3"></p>  
            <!-- ä¿®æ”¹ä¸ºæ”¹è¿›çš„å›¾ç‰‡å®¹å™¨ -->  
            <div class="post-image-container mb-3 hidden text-center">  
                <img class="post-image max-w-full max-h-96 inline-block object-contain rounded" alt="å‘å¸ƒçš„å›¾ç‰‡">  
            </div>  
            <div class="flex items-center space-x-4 text-gray-500 mb-3">  
                <button class="like-btn flex items-center space-x-1 hover:text-blue-500">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">  
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />  
                    </svg>  
                    <span class="like-count">0</span>  
                </button>  
                <button class="reply-btn flex items-center space-x-1 hover:text-blue-500">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">  
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />  
                    </svg>  
                    <span>å›å¤</span>  
                </button>  
                <button class="pin-btn hidden text-yellow-500 hover:text-yellow-700">ç½®é¡¶</button>  
                <button class="unpin-btn hidden text-yellow-500 hover:text-yellow-700">å–æ¶ˆç½®é¡¶</button>  
                <button class="delete-btn hidden text-red-500 hover:text-red-700">åˆ é™¤</button>  
            </div>  
            
            <!-- å›å¤åŒºåŸŸ -->  
            <div class="replies-section mt-2 border-t pt-2 hidden">  
                <div class="reply-form mb-3">  
                    <div class="flex flex-col">  
                        <input type="text" class="reply-input flex-grow px-3 py-1 border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 mb-2" placeholder="å›å¤è¿™æ¡æ¶ˆæ¯...">  
                        <div class="flex items-center justify-between">  
                            <button class="send-reply-btn px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">å‘é€å›å¤</button>  
                            <span class="text-xs text-gray-500">ğŸ’° å›å¤å¯è·å¾— 5 ç§¯åˆ†</span>  
                        </div>  
                    </div>  
                </div>  
                <div class="replies-container space-y-2"></div>  
            </div>  
        </div>  
    </template>  

    <!-- å›å¤æ¨¡æ¿ -->  
    <template id="replyTemplate">  
        <div class="reply bg-gray-50 p-2 rounded">  
            <div class="flex items-start">  
                <img class="reply-avatar w-6 h-6 rounded-full object-cover mr-2" src="https://via.placeholder.com/24" alt="å›å¤è€…å¤´åƒ">  
                <div class="flex-grow">  
                    <div class="flex items-center">  
                        <span class="reply-author font-medium text-sm mr-1"></span>  
                        <span class="reply-admin-badge hidden text-xs bg-red-500 text-white px-1 rounded">ç®¡ç†å‘˜</span>  
                        <span class="reply-time text-gray-400 text-xs ml-auto"></span>  
                    </div>  
                    <p class="reply-content text-sm"></p>  
                </div>  
                <button class="delete-reply-btn hidden text-red-500 hover:text-red-700 text-xs ml-2">åˆ é™¤</button>  
            </div>  
        </div>  
    </template>  

    <!-- ç®¡ç†å‘˜é¡¹æ¨¡æ¿ -->  
    <template id="adminItemTemplate">  
        <div class="admin-item flex items-center justify-between p-2 bg-gray-100 rounded">  
            <span class="admin-id font-medium"></span>  
            <button class="remove-admin-btn text-red-500 hover:text-red-700 text-sm">ç§»é™¤</button>  
        </div>  
    </template>  

    <!-- ç§¯åˆ†æ’è¡Œæ¦œé¡¹æ¨¡æ¿ -->  
    <template id="rankItemTemplate">  
        <div class="rank-item flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">  
            <div class="flex items-center space-x-4">  
                <div class="rank-number text-gray-600 font-bold text-lg w-8 text-center"></div>  
                <img class="rank-avatar w-12 h-12 rounded-full object-cover" src="https://via.placeholder.com/48" alt="ç”¨æˆ·å¤´åƒ">  
                <div>  
                    <div class="flex items-center space-x-2">  
                        <h4 class="rank-name font-semibold text-gray-800"></h4>  
                        <span class="rank-admin-badge hidden text-xs bg-red-500 text-white px-2 py-0.5 rounded">ç®¡ç†å‘˜</span>  
                    </div>  
                    <p class="rank-employee-id text-sm text-gray-500"></p>  
                    <p class="rank-streak text-xs text-orange-600 mt-1">ğŸ”¥ è¿ç»­ç­¾åˆ° <span class="rank-streak-days">0</span> å¤©</p>  
                </div>  
            </div>  
            <div class="text-right">  
                <p class="rank-points text-2xl font-bold text-yellow-600"></p>  
                <p class="text-xs text-gray-500">ç§¯åˆ†</p>  
            </div>  
        </div>  
    </template>  

    <script>  
        // Firebase é…ç½®  
        const firebaseConfig = {  
            apiKey: "AIzaSyC19CX0gSWAzvFevy43EQRy4uX1A265LuM",  
            authDomain: "youth-pi-space.firebaseapp.com",  
            databaseURL: "https://youth-pi-space-default-rtdb.asia-southeast1.firebasedatabase.app",  
            projectId: "youth-pi-space",  
            storageBucket: "youth-pi-space.firebasestorage.app",  
            messagingSenderId: "895213716516",  
            appId: "1:895213716516:web:9548b7964aaf3074b504b1"  
        };  
        
        // åˆå§‹åŒ– Firebase  
        firebase.initializeApp(firebaseConfig);  
        const database = firebase.database();  
        
        // å½“å‰ç”¨æˆ·å¯¹è±¡  
        let currentUser = null;  
        let isAdmin = false;  
        let isSystemAdmin = false;  
        
        // æ˜¯å¦å·²åŠ è½½è¿‡å¸–å­çš„æ ‡å¿—ï¼Œé¿å…é‡å¤å¤„ç†  
        let postsInitialized = false;  

        // æ˜¾ç¤º/éšè—åŠ è½½é®ç½©  
        function showLoading(show = true) {  
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);  
        }  

        // çŠ¶æ€æç¤º  
        function showToast(message, isSuccess = true) {  
            const toast = document.getElementById('statusToast');  
            toast.textContent = message;  
            toast.classList.remove('translate-y-20', 'opacity-0');  
            toast.classList.add('translate-y-0', 'opacity-100');  
            
            if (isSuccess) {  
                toast.classList.remove('bg-red-500');  
                toast.classList.add('bg-green-500');  
            } else {  
                toast.classList.remove('bg-green-500');  
                toast.classList.add('bg-red-500');  
            }  
            
            setTimeout(() => {  
                toast.classList.remove('translate-y-0', 'opacity-100');  
                toast.classList.add('translate-y-20', 'opacity-0');  
            }, 3000);  
        }  

        // ç”Ÿæˆå¯†ç å“ˆå¸Œ  
        function hashPassword(password, salt = null) {  
            if (!salt) {  
                // ç”Ÿæˆéšæœºç›å€¼  
                salt = CryptoJS.lib.WordArray.random(128/8).toString();  
            }  
            
            // ä½¿ç”¨ç›å€¼åˆ›å»ºPBKDF2å“ˆå¸Œ  
            const hash = CryptoJS.PBKDF2(password, salt, {  
                keySize: 512/32,  
                iterations: 1000  
            }).toString();  
            
            // è¿”å›æ ¼å¼: salt:hash  
            return salt + ":" + hash;  
        }  
        
        // éªŒè¯å¯†ç   
        function verifyPassword(password, storedHash) {  
            const [salt, hash] = storedHash.split(":");  
            const calculatedHash = hashPassword(password, salt);  
            return calculatedHash === storedHash;  
        }  

        // ========== æ–°å¢ï¼šç­¾åˆ°ç³»ç»Ÿå‡½æ•° ==========  
        
        // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰  
        function getTodayDateString() {  
            const today = new Date();  
            const year = today.getFullYear();  
            const month = String(today.getMonth() + 1).padStart(2, '0');  
            const day = String(today.getDate()).padStart(2, '0');  
            return `${year}-${month}-${day}`;  
        }  
        
        // æ£€æŸ¥æ˜¯å¦å·²ç­¾åˆ°  
        async function checkIfCheckedInToday() {  
            if (!currentUser) return false;  
            
            try {  
                const snapshot = await database.ref(`users/${currentUser.employee_id}/last_check_in_date`).once('value');  
                const lastCheckInDate = snapshot.val();  
                const today = getTodayDateString();  
                
                return lastCheckInDate === today;  
            } catch (error) {  
                console.error('æ£€æŸ¥ç­¾åˆ°çŠ¶æ€å¤±è´¥:', error);  
                return false;  
            }  
        }  
        
        // è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°  
        function calculateCheckInStreak(lastCheckInDate) {  
            if (!lastCheckInDate) return 0;  
            
            const today = new Date();  
            const lastDate = new Date(lastCheckInDate);  
            
            // é‡ç½®æ—¶é—´ä¸ºå½“å¤©0ç‚¹ï¼Œä¾¿äºæ¯”è¾ƒ  
            today.setHours(0, 0, 0, 0);  
            lastDate.setHours(0, 0, 0, 0);  
            
            const diffTime = today - lastDate;  
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));  
            
            // å¦‚æœæ˜¯ä»Šå¤©ç­¾åˆ°ï¼Œè¿”å›å½“å‰è¿ç»­å¤©æ•°  
            if (diffDays === 0) {  
                return currentUser.check_in_streak || 1;  
            }  
            // å¦‚æœæ˜¯æ˜¨å¤©ç­¾åˆ°ï¼Œè¿ç»­å¤©æ•°+1  
            else if (diffDays === 1) {  
                return (currentUser.check_in_streak || 0) + 1;  
            }  
            // å¦åˆ™ä¸­æ–­ï¼Œé‡æ–°å¼€å§‹  
            else {  
                return 1;  
            }  
        }  
        
        // æ¯æ—¥ç­¾åˆ°  
        async function dailyCheckIn() {  
            if (!currentUser) {  
                showToast('è¯·å…ˆç™»å½•', false);  
                return;  
            }  
            
            const checkInBtn = document.getElementById('checkInBtn');  
            
            try {  
                // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç­¾åˆ°  
                const alreadyCheckedIn = await checkIfCheckedInToday();  
                
                if (alreadyCheckedIn) {  
                    showToast('ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼', false);  
                    return;  
                }  
                
                // ç¦ç”¨æŒ‰é’®  
                checkInBtn.disabled = true;  
                
                const today = getTodayDateString();  
                const lastCheckInDate = currentUser.last_check_in_date;  
                const newStreak = calculateCheckInStreak(lastCheckInDate);  
                
                // æ›´æ–°æ•°æ®åº“  
                const updates = {  
                    last_check_in_date: today,  
                    check_in_streak: newStreak  
                };  
                
                await database.ref(`users/${currentUser.employee_id}`).update(updates);  
                
                // å¢åŠ 2åˆ†  
                const newPoints = await addUserPoints(currentUser.employee_id, 2, 'æ¯æ—¥ç­¾åˆ°');  
                
                // æ›´æ–°æœ¬åœ°æ•°æ®  
                currentUser.last_check_in_date = today;  
                currentUser.check_in_streak = newStreak;  
                
                // æ›´æ–°UI  
                updateCheckInUI();  
                
                // åŠ¨ç”»æ•ˆæœ  
                checkInBtn.classList.add('check-in-success');  
                setTimeout(() => {  
                    checkInBtn.classList.remove('check-in-success');  
                }, 500);  
                
                showToast(`ç­¾åˆ°æˆåŠŸï¼è·å¾—2ç§¯åˆ†ï¼Œè¿ç»­ç­¾åˆ°${newStreak}å¤©ğŸ‰`);  
                
            } catch (error) {  
                console.error('ç­¾åˆ°å¤±è´¥:', error);  
                showToast('ç­¾åˆ°å¤±è´¥: ' + error.message, false);  
                checkInBtn.disabled = false;  
            }  
        }  
        
        // æ›´æ–°ç­¾åˆ°æŒ‰é’®çŠ¶æ€  
        async function updateCheckInUI() {  
            if (!currentUser) return;  
            
            const checkInBtn = document.getElementById('checkInBtn');  
            const checkInBtnText = document.getElementById('checkInBtnText');  
            const checkInStreak = document.getElementById('checkInStreak');  
            const lastCheckInTime = document.getElementById('lastCheckInTime');  
            
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç­¾åˆ°  
            const alreadyCheckedIn = await checkIfCheckedInToday();  
            
            if (alreadyCheckedIn) {  
                checkInBtn.disabled = true;  
                checkInBtn.classList.remove('bg-green-500', 'hover:bg-green-600');  
                checkInBtn.classList.add('bg-gray-400');  
                checkInBtnText.textContent = 'å·²ç­¾åˆ°';  
            } else {  
                checkInBtn.disabled = false;  
                checkInBtn.classList.remove('bg-gray-400');  
                checkInBtn.classList.add('bg-green-500', 'hover:bg-green-600');  
                checkInBtnText.textContent = 'ç­¾åˆ°';  
            }  
            
            // æ›´æ–°è¿ç»­ç­¾åˆ°å¤©æ•°  
            const streak = currentUser.check_in_streak || 0;  
            if (checkInStreak) {  
                checkInStreak.innerHTML = `ğŸ”¥ è¿ç»­ç­¾åˆ° ${streak} å¤©`;  
            }  
            
            // æ›´æ–°ä¸Šæ¬¡ç­¾åˆ°æ—¶é—´  
            if (lastCheckInTime && currentUser.last_check_in_date) {  
                lastCheckInTime.textContent = `ä¸Šæ¬¡ç­¾åˆ°: ${currentUser.last_check_in_date}`;  
            }  
        }  

        // ========== ç§¯åˆ†ç³»ç»Ÿå‡½æ•° ==========  
        
        // å¢åŠ ç”¨æˆ·ç§¯åˆ†  
        async function addUserPoints(employeeId, points, reason = '') {  
            try {  
                const userRef = database.ref(`users/${employeeId}`);  
                const snapshot = await userRef.once('value');  
                
                if (snapshot.exists()) {  
                    const userData = snapshot.val();  
                    const currentPoints = userData.points || 0;  
                    const newPoints = currentPoints + points;  
                    
                    await userRef.update({ points: newPoints });  
                    
                    // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œæ›´æ–°æœ¬åœ°æ•°æ®å’ŒUI  
                    if (currentUser && currentUser.employee_id === employeeId) {  
                        currentUser.points = newPoints;  
                        updatePointsUI();  
                    }  
                    
                    console.log(`ç”¨æˆ· ${employeeId} è·å¾— ${points} ç§¯åˆ† (${reason}), å½“å‰æ€»ç§¯åˆ†: ${newPoints}`);  
                    return newPoints;  
                }  
            } catch (error) {  
                console.error('å¢åŠ ç§¯åˆ†å¤±è´¥:', error);  
            }  
            return 0;  
        }  

        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤ºUI  
        function updatePointsUI() {  
            if (currentUser) {  
                const points = currentUser.points || 0;  
                document.getElementById('navUserPoints').textContent = `${points}ç§¯åˆ†`;  
                document.getElementById('profilePoints').textContent = points;  
            }  
        }  

        // åŠ è½½ç§¯åˆ†æ’è¡Œæ¦œ  
        function loadRankingList() {  
            showLoading(true);  
            
            database.ref('users').once('value').then((snapshot) => {  
                const rankingList = document.getElementById('rankingList');  
                rankingList.innerHTML = '';  
                
                if (!snapshot.exists()) {  
                    rankingList.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— æ•°æ®</p>';  
                    showLoading(false);  
                    return;  
                }  
                
                // æ”¶é›†æ‰€æœ‰ç”¨æˆ·æ•°æ®  
                const users = [];  
                const pointsUpdates = {}; // ç”¨äºæ‰¹é‡æ›´æ–°ç¼ºå°‘ç§¯åˆ†çš„ç”¨æˆ·  
                
                snapshot.forEach((childSnapshot) => {  
                    const userData = childSnapshot.val();  
                    const employeeId = userData.employee_id;  
                    
                    // å¦‚æœç”¨æˆ·æ²¡æœ‰ç§¯åˆ†å­—æ®µï¼Œåˆå§‹åŒ–ä¸º0  
                    let points = userData.points;  
                    if (points === undefined || points === null) {  
                        points = 0;  
                        pointsUpdates[`users/${employeeId}/points`] = 0;  
                    }  
                    
                    // åˆå§‹åŒ–ç­¾åˆ°å­—æ®µ  
                    if (!userData.check_in_streak) {  
                        pointsUpdates[`users/${employeeId}/check_in_streak`] = 0;  
                    }  
                    
                    users.push({  
                        employee_id: employeeId,  
                        name: userData.name,  
                        avatar_url: userData.avatar_url,  
                        points: points,  
                        check_in_streak: userData.check_in_streak || 0,  
                        is_admin: userData.is_admin || false,  
                        is_system_admin: userData.is_system_admin || false  
                    });  
                });  
                
                // å¦‚æœæœ‰éœ€è¦æ›´æ–°çš„ç§¯åˆ†ï¼Œæ‰¹é‡æ›´æ–°  
                if (Object.keys(pointsUpdates).length > 0) {  
                    database.ref().update(pointsUpdates).then(() => {  
                        console.log('å·²åˆå§‹åŒ–ç¼ºå°‘ç§¯åˆ†çš„ç”¨æˆ·');  
                    });  
                }  
                
                // æŒ‰ç§¯åˆ†é™åºæ’åº  
                users.sort((a, b) => b.points - a.points);  
                
                // æ¸²æŸ“æ’è¡Œæ¦œ  
                const template = document.getElementById('rankItemTemplate');  
                
                users.forEach((user, index) => {  
                    const rankItem = template.content.cloneNode(true).querySelector('.rank-item');  
                    
                    // è®¾ç½®æ’å  
                    const rankNumber = rankItem.querySelector('.rank-number');  
                    if (index < 3) {  
                        // å‰ä¸‰åæ˜¾ç¤ºå¥–ç‰Œ  
                        rankNumber.classList.add('rank-medal', `rank-${index + 1}`);  
                        rankNumber.textContent = index + 1;  
                    } else {  
                        rankNumber.textContent = index + 1;  
                    }  
                    
                    // è®¾ç½®å¤´åƒ  
                    if (user.avatar_url) {  
                        rankItem.querySelector('.rank-avatar').src = user.avatar_url;  
                    }  
                    
                    // è®¾ç½®å§“å  
                    rankItem.querySelector('.rank-name').textContent = user.name;  
                    
                    // è®¾ç½®å·¥å·  
                    rankItem.querySelector('.rank-employee-id').textContent = `å·¥å·: ${user.employee_id}`;  
                    
                    // è®¾ç½®è¿ç»­ç­¾åˆ°å¤©æ•°  
                    rankItem.querySelector('.rank-streak-days').textContent = user.check_in_streak;  
                    
                    // æ˜¾ç¤ºç®¡ç†å‘˜æ ‡è¯†  
                    if (user.is_system_admin) {  
                        const badge = rankItem.querySelector('.rank-admin-badge');  
                        badge.classList.remove('hidden', 'bg-red-500');  
                        badge.classList.add('bg-purple-500');  
                        badge.textContent = 'ç³»ç»Ÿç®¡ç†å‘˜';  
                    } else if (user.is_admin) {  
                        rankItem.querySelector('.rank-admin-badge').classList.remove('hidden');  
                    }  
                    
                    // è®¾ç½®ç§¯åˆ†  
                    rankItem.querySelector('.rank-points').textContent = user.points;  
                    
                    // é«˜äº®å½“å‰ç”¨æˆ·  
                    if (currentUser && user.employee_id === currentUser.employee_id) {  
                        rankItem.classList.add('bg-blue-50', 'border-blue-400');  
                    }  
                    
                    rankingList.appendChild(rankItem);  
                });  
                
                showLoading(false);  
            }).catch(error => {  
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);  
                showToast('åŠ è½½æ’è¡Œæ¦œå¤±è´¥', false);  
                showLoading(false);  
            });  
        }  

        // è®¾ç½®ç§¯åˆ†æ’è¡Œæ¦œå®æ—¶ç›‘å¬  
        function setupRankingListener() {  
            database.ref('users').on('value', (snapshot) => {  
                // å¦‚æœå½“å‰åœ¨æ’è¡Œæ¦œé¡µé¢ï¼Œå®æ—¶æ›´æ–°  
                if (!document.getElementById('rankingSection').classList.contains('hidden')) {  
                    loadRankingList();  
                }  
                
                // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„ç§¯åˆ†å˜åŒ–ï¼Œæ›´æ–°UI  
                if (currentUser) {  
                    database.ref(`users/${currentUser.employee_id}`).once('value').then((userSnapshot) => {  
                        if (userSnapshot.exists()) {  
                            const userData = userSnapshot.val();  
                            currentUser.points = userData.points || 0;  
                            currentUser.check_in_streak = userData.check_in_streak || 0;  
                            currentUser.last_check_in_date = userData.last_check_in_date;  
                            updatePointsUI();  
                            updateCheckInUI();  
                        }  
                    });  
                }  
            });  
        }  

        // ========== é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– ==========  

        document.addEventListener('DOMContentLoaded', () => {  
            console.log('é¡µé¢åŠ è½½å®Œæˆ');  
            
            // åˆå§‹åŒ–ç®¡ç†å‘˜åˆ—è¡¨  
            initializeAdminList();  
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€  
            checkLoginStatus();  

            // ç™»å½•å’Œæ³¨å†Œè¡¨å•åˆ‡æ¢æŒ‰é’®  
            document.getElementById('showRegisterBtn').addEventListener('click', () => {  
                document.getElementById('loginContainer').classList.add('hidden');  
                document.getElementById('registerContainer').classList.remove('hidden');  
            });  
            
            document.getElementById('showLoginBtn').addEventListener('click', () => {  
                document.getElementById('registerContainer').classList.add('hidden');  
                document.getElementById('loginContainer').classList.remove('hidden');  
            });  
            
            // ç™»å½•æŒ‰é’®  
            document.getElementById('loginBtn').addEventListener('click', login);  
            
            // æ³¨å†ŒæŒ‰é’®  
            document.getElementById('registerBtn').addEventListener('click', register);  
            
            // é€€å‡ºç™»å½•æŒ‰é’®  
            document.getElementById('logoutBtn').addEventListener('click', logout);  
            
            // ç­¾åˆ°æŒ‰é’®  
            document.getElementById('checkInBtn').addEventListener('click', dailyCheckIn);  
            
            // ç¼–è¾‘ä¿¡æ¯æŒ‰é’®  
            document.getElementById('editProfileBtn').addEventListener('click', showEditProfileForm);  
            document.getElementById('cancelEditBtn').addEventListener('click', hideEditProfileForm);  
            
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯æŒ‰é’®  
            document.getElementById('saveUserInfoBtn').addEventListener('click', updateUserInfo);  

            // ç®¡ç†å‘˜é¢æ¿æŒ‰é’®  
            document.getElementById('adminPanelBtn').addEventListener('click', showAdminPanel);  
            document.getElementById('closeAdminPanelBtn').addEventListener('click', hideAdminPanel);  
            document.getElementById('addAdminBtn').addEventListener('click', addNewAdmin);  
            
            // ç”¨æˆ·ç®¡ç†æŒ‰é’®  
            document.getElementById('userManagementBtn').addEventListener('click', showUserManagement);  
            document.getElementById('closeUserManagementBtn').addEventListener('click', hideUserManagement);  

            // æ¿å—åˆ‡æ¢  
            document.querySelectorAll('.section-btn').forEach(btn => {  
                btn.addEventListener('click', () => {  
                    const sectionId = btn.dataset.section;  
                    
                    // æ›´æ–°æŒ‰é’®æ ·å¼  
                    document.querySelectorAll('.section-btn').forEach(b => {  
                        if (b.dataset.section === sectionId) {  
                            b.classList.add('bg-blue-500', 'text-white');  
                            b.classList.remove('bg-gray-200');  
                        } else {  
                            b.classList.remove('bg-blue-500', 'text-white');  
                            b.classList.add('bg-gray-200');  
                        }  
                    });  
                    
                    // æ˜¾ç¤ºå¯¹åº”æ¿å—å†…å®¹  
                    document.querySelectorAll('.section-content').forEach(content => {  
                        content.classList.add('hidden');  
                        if (content.id === `${sectionId}Section`) {  
                            content.classList.remove('hidden');  
                            
                            // å¦‚æœåˆ‡æ¢åˆ°æ’è¡Œæ¦œï¼ŒåŠ è½½æ’è¡Œæ¦œæ•°æ®  
                            if (sectionId === 'ranking') {  
                                loadRankingList();  
                            }  
                        }  
                    });  
                });  
            });  

            // å‘å¸ƒå¸–å­  
            document.getElementById('techPostBtn').addEventListener('click', () => createPost('tech'));  
            document.getElementById('dailyPostBtn').addEventListener('click', () => createPost('daily'));  

            // æ›´æ¢å¤´åƒ  
            document.getElementById('changeAvatarBtn').addEventListener('click', () =>   
                document.getElementById('avatarInput').click()  
            );  
            document.getElementById('avatarInput').addEventListener('change', updateAvatar);  
            
            // åˆå§‹åŒ–ç³»ç»Ÿç®¡ç†å‘˜è´¦å·  
            addInitialSystemAdmin();  
        });  
        
        // åˆå§‹åŒ–ç³»ç»Ÿç®¡ç†å‘˜è´¦å·  
        function addInitialSystemAdmin() {  
            database.ref('users/admin001').once('value').then((snapshot) => {  
                if (!snapshot.exists()) {  
                    console.log('åˆ›å»ºç³»ç»Ÿç®¡ç†å‘˜è´¦å·');  
                    
                    const adminUser = {  
                        id: "admin001",  
                        name: "ç³»ç»Ÿç®¡ç†å‘˜",  
                        employee_id: "admin001",  
                        password_hash: "QJEzWGpBYm1YQXg6N2NkY2UxYmQ4YzNkMzU3YWQwNjc5YTc4YjIxNGE0NDZhNDI5MmY4MDQwNzg0YTcwNTQzZjNhOTE2NzQyZDA3Yw==",  
                        avatar_url: "https://via.placeholder.com/100",  
                        is_admin: true,  
                        is_system_admin: true,  
                        points: 0,  
                        check_in_streak: 0,  
                        last_check_in_date: null,  
                        created_at: new Date().toISOString()  
                    };  
                    
                    database.ref('users/admin001').set(adminUser);  
                    database.ref('admins/admin001').set(true);  
                }  
            });  
        }  
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€  
        function checkLoginStatus() {  
            const sessionData = localStorage.getItem('userSession');  
            if (sessionData) {  
                try {  
                    const session = JSON.parse(sessionData);  
                    const now = new Date().getTime();  
                    if (session.expires > now) {  
                        database.ref(`users/${session.employee_id}`).once('value').then((snapshot) => {  
                            if (snapshot.exists()) {  
                                currentUser = snapshot.val();  
                                checkAndUpdateAdminStatus();  
                                
                                addInitialPostsIfNeeded();  
                                setupRealTimeListeners();  
                                setupRankingListener();  
                                
                                showMainUI();  
                                updateCheckInUI(); // æ›´æ–°ç­¾åˆ°æŒ‰é’®çŠ¶æ€  
                            } else {  
                                logout();  
                            }  
                        });  
                    } else {  
                        logout();  
                    }  
                } catch (error) {  
                    console.error('è§£æä¼šè¯æ•°æ®å‡ºé”™:', error);  
                    logout();  
                }  
            } else {  
                document.getElementById('loginContainer').classList.remove('hidden');  
                document.getElementById('mainContainer').classList.add('hidden');  
                document.getElementById('adminPanelContainer').classList.add('hidden');  
                document.getElementById('userInfoContainer').classList.add('hidden');  
                document.getElementById('userManagementContainer').classList.add('hidden');  
                document.getElementById('userNav').classList.add('hidden');  
            }  
        }  
        
        // ç™»å½•  
        function login() {  
            const employeeId = document.getElementById('loginEmployeeId').value.trim();  
            const password = document.getElementById('loginPassword').value;  
            
            if (!employeeId || !password) {  
                showToast('è¯·è¾“å…¥å·¥å·å’Œå¯†ç ', false);  
                return;  
            }  
            
            showLoading(true);  
            
            // ç³»ç»Ÿç®¡ç†å‘˜ç‰¹æ®Šå¤„ç†  
            if (employeeId === 'admin001' && password === 'admin123') {  
                database.ref(`users/admin001`).once('value').then((snapshot) => {  
                    if (snapshot.exists()) {  
                        currentUser = snapshot.val();  
                        isAdmin = true;  
                        isSystemAdmin = true;  
                        
                        const session = {  
                            employee_id: employeeId,  
                            expires: new Date().getTime() + (24 * 60 * 60 * 1000)  
                        };  
                        localStorage.setItem('userSession', JSON.stringify(session));  
                        
                        document.getElementById('loginEmployeeId').value = '';  
                        document.getElementById('loginPassword').value = '';  
                        
                        addInitialPostsIfNeeded();  
                        setupRealTimeListeners();  
                        setupRankingListener();  
                        
                        showMainUI();  
                        updateCheckInUI();  
                        showToast('ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•æˆåŠŸ');  
                    } else {  
                        addInitialSystemAdmin();  
                        showToast('å·²åˆå§‹åŒ–ç³»ç»Ÿï¼Œè¯·å†æ¬¡ç™»å½•', false);  
                    }  
                    showLoading(false);  
                }).catch(error => {  
                    console.error('ç³»ç»Ÿç®¡ç†å‘˜ç™»å½•å‡ºé”™:', error);  
                    showToast('ç™»å½•å¤±è´¥: ' + error.message, false);  
                    showLoading(false);  
                });  
                return;  
            }  
            
            // æ™®é€šç”¨æˆ·ç™»å½•  
            database.ref(`users/${employeeId}`).once('value').then((snapshot) => {  
                if (snapshot.exists()) {  
                    const userData = snapshot.val();  
                    
                    if (verifyPassword(password, userData.password_hash)) {  
                        currentUser = userData;  
                        
                        const session = {  
                            employee_id: employeeId,  
                            expires: new Date().getTime() + (24 * 60 * 60 * 1000)  
                        };  
                        localStorage.setItem('userSession', JSON.stringify(session));  
                        
                        checkAndUpdateAdminStatus();  
                        
                        document.getElementById('loginEmployeeId').value = '';  
                        document.getElementById('loginPassword').value = '';  
                        
                        addInitialPostsIfNeeded();  
                        setupRealTimeListeners();  
                        setupRankingListener();  
                        
                        showMainUI();  
                        updateCheckInUI();  
                        showToast('ç™»å½•æˆåŠŸ');  
                    } else {  
                        showToast('å¯†ç é”™è¯¯', false);  
                    }  
                } else {  
                    showToast('è¯¥å·¥å·å°šæœªæ³¨å†Œ', false);  
                }  
                showLoading(false);  
            }).catch(error => {  
                console.error('ç™»å½•å‡ºé”™:', error);  
                showToast('ç™»å½•å¤±è´¥: ' + error.message, false);  
                showLoading(false);  
            });  
        }  
        
        // æ³¨å†Œ  
        async function register() {  
            const name = document.getElementById('registerName').value.trim();  
            const employeeId = document.getElementById('registerEmployeeId').value.trim();  
            const password = document.getElementById('registerPassword').value;  
            const confirmPassword = document.getElementById('confirmPassword').value;  
            const avatarFile = document.getElementById('registerAvatar').files[0];  
            
            if (!name || !employeeId || !password) {  
                showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', false);  
                return;  
            }  
            
            if (password !== confirmPassword) {  
                showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', false);  
                return;  
            }  
            
            if (password.length < 6) {  
                showToast('å¯†ç é•¿åº¦è‡³å°‘6ä½', false);  
                return;  
            }  
            
            showLoading(true);  
            
            try {  
                const snapshot = await database.ref(`users/${employeeId}`).once('value');  
                if (snapshot.exists()) {  
                    showToast('è¯¥å·¥å·å·²è¢«æ³¨å†Œ', false);  
                    showLoading(false);  
                    return;  
                }  
                
                let avatarUrl = 'https://via.placeholder.com/100';  
                if (avatarFile) {  
                    const compressedFile = await compressImage(avatarFile);  
                    avatarUrl = await uploadImageToImgBB(compressedFile);  
                    if (!avatarUrl) {  
                        showToast('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ', false);  
                        avatarUrl = 'https://via.placeholder.com/100';  
                    }  
                }  
                
                const userId = generateId();  
                const passwordHash = hashPassword(password);  
                
                const newUser = {  
                    id: userId,  
                    name: name,  
                    employee_id: employeeId,  
                    password_hash: passwordHash,
                    avatar_url: avatarUrl,
                    is_admin: false,
                    is_system_admin: false,
                    points: 0,
                    check_in_streak: 0,
                    last_check_in_date: null,
                    created_at: new Date().toISOString()
                };
                
                await database.ref(`users/${employeeId}`).set(newUser);
                
                document.getElementById('registerName').value = '';
                document.getElementById('registerEmployeeId').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('registerAvatar').value = '';
                
                showToast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                
                document.getElementById('registerContainer').classList.add('hidden');
                document.getElementById('loginContainer').classList.remove('hidden');
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                showToast('æ³¨å†Œå¤±è´¥: ' + error.message, false);
            } finally {
                showLoading(false);
            }
        }
        
        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('userSession');
            currentUser = null;
            isAdmin = false;
            isSystemAdmin = false;
            
            postsInitialized = false;
            
            database.ref('posts').off();
            database.ref('replies').off();
            database.ref('users').off();
            
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('adminPanelContainer').classList.add('hidden');
            document.getElementById('userInfoContainer').classList.add('hidden');
            document.getElementById('userManagementContainer').classList.add('hidden');
            document.getElementById('userNav').classList.add('hidden');
            
            showToast('å·²é€€å‡ºç™»å½•');
        }
        
        // æ˜¾ç¤ºç¼–è¾‘ä¸ªäººä¿¡æ¯è¡¨å•
        function showEditProfileForm() {
            if (!currentUser) return;
            
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('userInfoContainer').classList.remove('hidden');
            
            document.getElementById('userName').value = currentUser.name;
        }
        
        // éšè—ç¼–è¾‘ä¸ªäººä¿¡æ¯è¡¨å•
        function hideEditProfileForm() {
            document.getElementById('userInfoContainer').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
        }
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        async function updateUserInfo() {
            if (!currentUser) return;
            
            const name = document.getElementById('userName').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const avatarFile = document.getElementById('userAvatar').files[0];
            
            if (!name) {
                showToast('å§“åä¸èƒ½ä¸ºç©º', false);
                return;
            }
            
            if (newPassword) {
                if (newPassword.length < 6) {
                    showToast('å¯†ç é•¿åº¦è‡³å°‘6ä½', false);
                    return;
                }
                
                if (newPassword !== confirmNewPassword) {
                    showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', false);
                    return;
                }
            }
            
            showLoading(true);
            
            try {
                const updates = {
                    name: name
                };
                
                if (newPassword) {
                    updates.password_hash = hashPassword(newPassword);
                }
                
                if (avatarFile) {
                    const compressedFile = await compressImage(avatarFile);
                    const avatarUrl = await uploadImageToImgBB(compressedFile);
                    if (avatarUrl) {
                        updates.avatar_url = avatarUrl;
                    }
                }
                
                await database.ref(`users/${currentUser.employee_id}`).update(updates);
                
                Object.assign(currentUser, updates);
                
                if (avatarFile && updates.avatar_url) {
                    updatePostsWithNewAvatar(updates.avatar_url);
                    updateRepliesWithNewAvatar(updates.avatar_url);
                }
                
                if (name !== currentUser.name) {
                    updatePostsWithNewName(name);
                    updateRepliesWithNewName(name);
                }
                
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                document.getElementById('userAvatar').value = '';
                
                hideEditProfileForm();
                showMainUI();
                showToast('ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ');
            } catch (error) {
                console.error('æ›´æ–°å¤±è´¥:', error);
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, false);
            } finally {
                showLoading(false);
            }
        }

        // åˆå§‹åŒ–ç®¡ç†å‘˜åˆ—è¡¨
        function initializeAdminList() {
            database.ref('admins').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    const defaultAdmins = {
                        'admin001': true
                    };
                    database.ref('admins').set(defaultAdmins);
                }
                
                database.ref('admins').on('value', (snapshot) => {
                    updateAdminList(snapshot);
                    
                    if (currentUser) {
                        checkAndUpdateAdminStatus();
                    }
                });
            });
        }
        
        // æ›´æ–°ç®¡ç†å‘˜åˆ—è¡¨UI
        function updateAdminList(snapshot) {
            const adminList = document.getElementById('adminList');
            adminList.innerHTML = '';
            
            if (!snapshot.exists()) {
                adminList.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— ç®¡ç†å‘˜</p>';
                return;
            }
            
            const admins = [];
            snapshot.forEach((childSnapshot) => {
                admins.push(childSnapshot.key);
            });
            
            if (admins.length === 0) {
                adminList.innerHTML = '<p class="text-gray-500 text-center">æš‚æ— ç®¡ç†å‘˜</p>';
                return;
            }
            
            admins.sort();
            
            const template = document.getElementById('adminItemTemplate');
            
            admins.forEach(adminId => {
                const adminElement = template.content.cloneNode(true).querySelector('.admin-item');
                adminElement.querySelector('.admin-id').textContent = adminId;
                
                if (adminId === 'admin001') {
                    adminElement.querySelector('.remove-admin-btn').textContent = 'ç³»ç»Ÿç®¡ç†å‘˜';
                    adminElement.querySelector('.remove-admin-btn').disabled = true;
                    adminElement.querySelector('.remove-admin-btn').classList.add('text-gray-400');
                    adminElement.querySelector('.remove-admin-btn').classList.remove('text-red-500', 'hover:text-red-700');
                } else {
                    adminElement.querySelector('.remove-admin-btn').addEventListener('click', () => {
                        removeAdmin(adminId);
                    });
                }
                
                adminList.appendChild(adminElement);
            });
        }
        
        // æ·»åŠ æ–°ç®¡ç†å‘˜
        function addNewAdmin() {
            if (!isAdmin) {
                showToast('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ å…¶ä»–ç®¡ç†å‘˜', false);
                return;
            }
            
            if (!isSystemAdmin) {
                showToast('åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥æ·»åŠ å…¶ä»–ç®¡ç†å‘˜', false);
                return;
            }
            
            const newAdminId = document.getElementById('newAdminId').value.trim();
            if (!newAdminId) {
                showToast('è¯·è¾“å…¥å·¥å·', false);
                return;
            }
            
            database.ref(`admins/${newAdminId}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    showToast('è¯¥å·¥å·å·²ç»æ˜¯ç®¡ç†å‘˜', false);
                    return;
                }
                
                database.ref(`users/${newAdminId}`).once('value').then((userSnapshot) => {
                    if (!userSnapshot.exists()) {
                        showToast('è¯¥å·¥å·å°šæœªæ³¨å†Œ', false);
                        return;
                    }
                    
                    database.ref(`admins/${newAdminId}`).set(true)
                        .then(() => {
                            document.getElementById('newAdminId').value = '';
                            showToast(`å·²å°†å·¥å· ${newAdminId} è®¾ä¸ºç®¡ç†å‘˜`);
                            
                            database.ref(`users/${newAdminId}`).update({ is_admin: true });
                            updateUserContentAdminStatusByEmployeeId(newAdminId, true);
                        })
                        .catch(error => {
                            console.error('æ·»åŠ ç®¡ç†å‘˜å¤±è´¥:', error);
                            showToast('æ·»åŠ ç®¡ç†å‘˜å¤±è´¥: ' + error.message, false);
                        });
                });
            });
        }
        
        // ç§»é™¤ç®¡ç†å‘˜
        function removeAdmin(adminId) {
            if (!isAdmin) {
                showToast('åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç§»é™¤å…¶ä»–ç®¡ç†å‘˜', false);
                return;
            }
            
            if (!isSystemAdmin) {
                showToast('åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥ç§»é™¤å…¶ä»–ç®¡ç†å‘˜', false);
                return;
            }
            
            if (adminId === 'admin001') {
                showToast('ç³»ç»Ÿç®¡ç†å‘˜ä¸èƒ½è¢«ç§»é™¤', false);
                return;
            }
            
            database.ref(`admins/${adminId}`).remove()
                .then(() => {
                    showToast(`å·²ç§»é™¤ç®¡ç†å‘˜ ${adminId}`);
                    
                    database.ref(`users/${adminId}`).update({ is_admin: false });
                    updateUserContentAdminStatusByEmployeeId(adminId, false);
                })
                .catch(error => {
                    console.error('ç§»é™¤ç®¡ç†å‘˜å¤±è´¥:', error);
                    showToast('ç§»é™¤ç®¡ç†å‘˜å¤±è´¥: ' + error.message, false);
                });
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
        function showAdminPanel() {
            if (!isAdmin) {
                showToast('åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®è®¾ç½®', false);
                return;
            }
            
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('adminPanelContainer').classList.remove('hidden');
            
            database.ref('admins').once('value').then(updateAdminList);
        }
        
        // éšè—ç®¡ç†å‘˜é¢æ¿
        function hideAdminPanel() {
            document.getElementById('adminPanelContainer').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ç®¡ç†é¢æ¿
        function showUserManagement() {
            if (!isSystemAdmin) {
                showToast('åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†', false);
                return;
            }
            
            document.getElementById('mainContainer').classList.add('hidden');
            document.getElementById('userManagementContainer').classList.remove('hidden');
            
            loadAllUsers();
        }
        
        // éšè—ç”¨æˆ·ç®¡ç†é¢æ¿
        function hideUserManagement() {
            document.getElementById('userManagementContainer').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
        }
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·æ•°æ®
        function loadAllUsers() {
            showLoading(true);
            
            database.ref('users').once('value').then((snapshot) => {
                const userTable = document.getElementById('userTable');
                userTable.innerHTML = '';
                
                if (!snapshot.exists()) {
                    userTable.innerHTML = '<tr><td colspan="7" class="py-2 px-4 text-center">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                    showLoading(false);
                    return;
                }
                
                const users = [];
                snapshot.forEach((childSnapshot) => {
                    users.push(childSnapshot.val());
                });
                
                users.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    
                    const idCell = document.createElement('td');
                    idCell.className = 'py-2 px-4 border-b border-gray-200';
                    idCell.textContent = user.employee_id;
                    row.appendChild(idCell);
                    
                    const nameCell = document.createElement('td');
                    nameCell.className = 'py-2 px-4 border-b border-gray-200';
                    nameCell.textContent = user.name;
                    row.appendChild(nameCell);
                    
                    // ç§¯åˆ†åˆ—
                    const pointsCell = document.createElement('td');
                    pointsCell.className = 'py-2 px-4 border-b border-gray-200 font-bold text-yellow-600';
                    pointsCell.textContent = user.points || 0;
                    row.appendChild(pointsCell);
                    
                    // è¿ç»­ç­¾åˆ°åˆ—
                    const streakCell = document.createElement('td');
                    streakCell.className = 'py-2 px-4 border-b border-gray-200';
                    streakCell.innerHTML = `<span class="text-orange-600">ğŸ”¥ ${user.check_in_streak || 0} å¤©</span>`;
                    row.appendChild(streakCell);
                    
                    const timeCell = document.createElement('td');
                    timeCell.className = 'py-2 px-4 border-b border-gray-200';
                    timeCell.textContent = new Date(user.created_at).toLocaleString();
                    row.appendChild(timeCell);
                    
                    const adminCell = document.createElement('td');
                    adminCell.className = 'py-2 px-4 border-b border-gray-200';
                    if (user.is_system_admin) {
                        adminCell.innerHTML = '<span class="bg-purple-500 text-white px-2 py-0.5 rounded">ç³»ç»Ÿç®¡ç†å‘˜</span>';
                    } else if (user.is_admin) {
                        adminCell.innerHTML = '<span class="bg-red-500 text-white px-2 py-0.5 rounded">ç®¡ç†å‘˜</span>';
                    } else {
                        adminCell.textContent = 'æ™®é€šç”¨æˆ·';
                    }
                    row.appendChild(adminCell);
                    
                    const actionCell = document.createElement('td');
                    actionCell.className = 'py-2 px-4 border-b border-gray-200';
                    
                    if (!user.is_system_admin) {
                        const adminBtn = document.createElement('button');
                        adminBtn.className = user.is_admin 
                            ? 'mr-2 px-2 py-1 bg-yellow-500 text-white rounded text-xs'
                            : 'mr-2 px-2 py-1 bg-green-500 text-white rounded text-xs';
                        adminBtn.textContent = user.is_admin ? 'ç§»é™¤ç®¡ç†å‘˜' : 'è®¾ä¸ºç®¡ç†å‘˜';
                        adminBtn.addEventListener('click', () => {
                            if (user.is_admin) {
                                removeAdmin(user.employee_id);
                                setTimeout(() => loadAllUsers(), 500);
                            } else {
                                addAdminFromUserManagement(user.employee_id);
                                setTimeout(() => loadAllUsers(), 500);
                            }
                        });
                        actionCell.appendChild(adminBtn);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'px-2 py-1 bg-red-500 text-white rounded text-xs';
                        deleteBtn.textContent = 'åˆ é™¤';
                        deleteBtn.addEventListener('click', () => {
                            if (confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${user.name} (${user.employee_id}) å—ï¼Ÿ`)) {
                                deleteUser(user.employee_id);
                            }
                        });
                        actionCell.appendChild(deleteBtn);
                    } else {
                        actionCell.textContent = 'ç³»ç»Ÿç®¡ç†å‘˜ä¸å¯ä¿®æ”¹';
                    }
                    
                    row.appendChild(actionCell);
                    
                    userTable.appendChild(row);
                });
                
                showLoading(false);
            }).catch(error => {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥', false);
                showLoading(false);
            });
        }
        
        // ä»ç”¨æˆ·ç®¡ç†ç•Œé¢æ·»åŠ ç®¡ç†å‘˜
        function addAdminFromUserManagement(employeeId) {
            if (!isSystemAdmin) {
                showToast('åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥æ·»åŠ å…¶ä»–ç®¡ç†å‘˜', false);
                return;
            }
            
            database.ref(`admins/${employeeId}`).set(true)
                .then(() => {
                    showToast(`å·²å°†å·¥å· ${employeeId} è®¾ä¸ºç®¡ç†å‘˜`);
                    
                    database.ref(`users/${employeeId}`).update({ is_admin: true });
                    updateUserContentAdminStatusByEmployeeId(employeeId, true);
                    
                    loadAllUsers();
                })
                .catch(error => {
                    console.error('æ·»åŠ ç®¡ç†å‘˜å¤±è´¥:', error);
                    showToast('æ·»åŠ ç®¡ç†å‘˜å¤±è´¥: ' + error.message, false);
                });
        }
        
        // åˆ é™¤ç”¨æˆ·
        function deleteUser(employeeId) {
            if (!isSystemAdmin) {
                showToast('åªæœ‰ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç”¨æˆ·', false);
                return;
            }
            
            showLoading(true);
            
            database.ref(`admins/${employeeId}`).remove()
                .then(() => {
                    return database.ref('posts').orderByChild('author_employee_id').equalTo(employeeId).once('value');
                })
                .then((snapshot) => {
                    const promises = [];
                    snapshot.forEach((childSnapshot) => {
                        promises.push(database.ref(`posts/${childSnapshot.key}`).remove());
                    });
                    return Promise.all(promises);
                })
                .then(() => {
                    return database.ref('replies').orderByChild('author_employee_id').equalTo(employeeId).once('value');
                })
                .then((snapshot) => {
                    const promises = [];
                    snapshot.forEach((childSnapshot) => {
                        promises.push(database.ref(`replies/${childSnapshot.key}`).remove());
                    });
                    return Promise.all(promises);
                })
                .then(() => {
                    return database.ref(`users/${employeeId}`).remove();
                })
                .then(() => {
                    showToast(`ç”¨æˆ· ${employeeId} åˆ é™¤æˆåŠŸ`);
                    loadAllUsers();
                })
                .catch(error => {
                    console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                    showToast('åˆ é™¤ç”¨æˆ·å¤±è´¥: ' + error.message, false);
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        // æ£€æŸ¥å¹¶æ›´æ–°å½“å‰ç”¨æˆ·çš„ç®¡ç†å‘˜çŠ¶æ€
        function checkAndUpdateAdminStatus() {
            if (!currentUser) return;
            
            if (currentUser.employee_id === 'admin001' || currentUser.is_system_admin) {
                isAdmin = true;
                isSystemAdmin = true;
                updateAdminUI();
                return;
            }
            
            database.ref(`admins/${currentUser.employee_id}`).once('value').then((snapshot) => {
                isAdmin = snapshot.exists();
                isSystemAdmin = false;
                
                updateAdminUI();
                
                if (isAdmin !== currentUser.is_admin) {
                    updateUserContentAdminStatus();
                    currentUser.is_admin = isAdmin;
                }
            });
        }
        
        // æ›´æ–°ç®¡ç†å‘˜UIæ˜¾ç¤º
        function updateAdminUI() {
            document.getElementById('adminPanelBtn').classList.toggle('hidden', !isAdmin);
            document.getElementById('adminBadge').classList.toggle('hidden', !isAdmin);
            document.getElementById('systemAdminBadge').classList.toggle('hidden', !isSystemAdmin);
            document.getElementById('userManagementBtn').classList.toggle('hidden', !isSystemAdmin);
        }
        
        // æ›´æ–°ç”¨æˆ·å‘å¸ƒå†…å®¹ä¸­çš„ç®¡ç†å‘˜çŠ¶æ€
        function updateUserContentAdminStatus() {
            if (!currentUser) return;
            
            updateUserContentAdminStatusByEmployeeId(currentUser.employee_id, isAdmin);
        }
        
        // æ ¹æ®å·¥å·æ›´æ–°ç”¨æˆ·å‘å¸ƒå†…å®¹ä¸­çš„ç®¡ç†å‘˜çŠ¶æ€
        function updateUserContentAdminStatusByEmployeeId(employeeId, isAdmin) {
            database.ref('posts').orderByChild('author_employee_id').equalTo(employeeId).once('value')
                .then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        childSnapshot.ref.update({ is_admin: isAdmin });
                    });
                });
            
            database.ref('replies').orderByChild('author_employee_id').equalTo(employeeId).once('value')
                .then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        childSnapshot.ref.update({ is_admin: isAdmin });
                    });
                });
        }

        // æ˜¾ç¤ºä¸»è¦UI
        function showMainUI() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('registerContainer').classList.add('hidden');
            document.getElementById('userInfoContainer').classList.add('hidden');
            document.getElementById('adminPanelContainer').classList.add('hidden');
            document.getElementById('userManagementContainer').classList.add('hidden');
            document.getElementById('mainContainer').classList.remove('hidden');
            document.getElementById('userNav').classList.remove('hidden');
            
            document.getElementById('navUserName').textContent = currentUser.name;
            if (currentUser.avatar_url) {
                document.getElementById('navUserAvatar').src = currentUser.avatar_url;
            }
            
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmployeeId').textContent = currentUser.employee_id;
            if (currentUser.avatar_url) {
                document.getElementById('profileAvatar').src = currentUser.avatar_url;
            }
            
            // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
            updatePointsUI();
            
            updateAdminUI();
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // è®¾ç½®å®æ—¶ç›‘å¬
        function setupRealTimeListeners() {
            if (postsInitialized) return;
            
            postsInitialized = true;
            
            database.ref('posts').on('value', (snapshot) => {
                console.log('æ”¶åˆ°å¸–å­æ›´æ–°');
                renderPosts(snapshot);
            });
            
            database.ref('replies').on('value', (snapshot) => {
                console.log('æ”¶åˆ°å›å¤æ›´æ–°');
                updateAllReplies(snapshot);
            });
        }

        // å›¾ç‰‡å‹ç¼©åŠŸèƒ½
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 800;
                        
                        if (width > height && width > maxSize) {
                            height = Math.round(height * maxSize / width);
                            width = maxSize;
                        } else if (height > maxSize) {
                            width = Math.round(width * maxSize / height);
                            height = maxSize;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(function(blob) {
                            resolve(new File([blob], file.name || 'image.jpg', {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            }));
                        }, 'image/jpeg', 0.7);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // å¢å¼ºç‰ˆå›¾ç‰‡ä¸Šä¼ å‡½æ•°
        async function uploadImageToImgBB(file) {
            try {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const result = reader.result;
                        if (typeof result === 'string' && result.startsWith('data:')) {
                            console.log("æˆåŠŸç”Ÿæˆå›¾ç‰‡æ•°æ®URL");
                            resolve(result);
                        } else {
                            console.error('å›¾ç‰‡ç¼–ç å¼‚å¸¸');
                            resolve(null);
                        }
                    };
                    reader.onerror = () => {
                        console.error('è¯»å–æ–‡ä»¶å¤±è´¥');
                        resolve(null);
                    };
                    reader.readAsDataURL(file);
                });
            } catch (error) {
                console.error('å›¾ç‰‡å¤„ç†é”™è¯¯:', error);
                return null;
            }
        }

        // åˆ›å»ºå¸–å­
        async function createPost(section) {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', false);
                return;
            }
            
            const contentElem = document.getElementById(`${section}PostContent`);
            const imageElem = document.getElementById(`${section}PostImage`);
            const content = contentElem.value.trim();
            const imageFile = imageElem.files[0];
            
            if (!content) {
                showToast('è¯·è¾“å…¥å†…å®¹', false);
                return;
            }
            
            showLoading(true);
            
            try {
                let imageUrl = null;
                
                if (imageFile) {
                    const compressedFile = await compressImage(imageFile);
                    imageUrl = await uploadImageToImgBB(compressedFile);
                }
                
                const postId = generateId();
                const newPost = {
                    id: postId,
                    author_name: currentUser.name,
                    author_employee_id: currentUser.employee_id,
                    author_avatar: currentUser.avatar_url,
                    content: content,
                    image_url: imageUrl,
                    section: section,
                    is_admin: isAdmin,
                    is_pinned: false,
                    likes: 0,
                    created_at: new Date().toISOString()
                };
                
                await database.ref('posts/' + postId).set(newPost);
                
                // å‘å¸–å¢åŠ 10åˆ†
                await addUserPoints(currentUser.employee_id, 10, 'å‘å¸–');
                
                contentElem.value = '';
                imageElem.value = '';
                showToast('å‘å¸ƒæˆåŠŸï¼Œè·å¾—10ç§¯åˆ†ï¼');
            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showToast('å‘å¸ƒå¤±è´¥: ' + error.message, false);
            } finally {
                showLoading(false);
            }
        }
        
        // æ¸²æŸ“å¸–å­
        function renderPosts(snapshot) {
            showLoading(true);
            
            try {
                document.getElementById('techPosts').innerHTML = '';
                document.getElementById('dailyPosts').innerHTML = '';
                document.getElementById('userPosts').innerHTML = '';
                
                const posts = [];
                snapshot.forEach((childSnapshot) => {
                    posts.push(childSnapshot.val());
                });
                
                posts.sort((a, b) => {
                    if (a.is_pinned && !b.is_pinned) return -1;
                    if (!a.is_pinned && b.is_pinned) return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    
                    if (post.section === 'tech') {
                        document.getElementById('techPosts').appendChild(postElement.cloneNode(true));
                    } else if (post.section === 'daily') {
                        document.getElementById('dailyPosts').appendChild(postElement.cloneNode(true));
                    }
                    
                    if (currentUser && post.author_employee_id === currentUser.employee_id) {
                        document.getElementById('userPosts').appendChild(postElement);
                    }
                });
                
                attachPostEvents();
                
                database.ref('replies').once('value').then(updateAllReplies);
                
            } catch (error) {
                console.error('æ¸²æŸ“å¸–å­å‡ºé”™:', error);
                showToast('åŠ è½½å¸–å­å‡ºé”™', false);
            } finally {
                showLoading(false);
            }
        }

        // åˆ›å»ºå¸–å­DOMå…ƒç´ 
        function createPostElement(post) {
            const template = document.getElementById('postTemplate');
            const postElement = template.content.cloneNode(true).querySelector('.post');
            
            postElement.dataset.id = post.id;
            
            const avatarElem = postElement.querySelector('.post-avatar');
            if (post.author_avatar) {
                avatarElem.src = post.author_avatar;
            }
            
            postElement.querySelector('.post-author').textContent = post.author_name;
            
            if (post.is_admin) {
                postElement.querySelector('.post-admin-badge').classList.remove('hidden');
            }
            
            if (post.is_pinned) {
                postElement.querySelector('.post-pinned-badge').classList.remove('hidden');
            }
            
            const date = new Date(post.created_at);
            postElement.querySelector('.post-time').textContent = date.toLocaleString();
            
            postElement.querySelector('.post-content').textContent = post.content;
            
            if (post.image_url) {
                const imageContainer = postElement.querySelector('.post-image-container');
                const imageElem = postElement.querySelector('.post-image');
                
                imageContainer.classList.remove('hidden');
                imageElem.src = post.image_url;
                
                imageElem.addEventListener('error', function() {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°è¯•é‡æ–°åŠ è½½', post.image_url);
                    setTimeout(() => {
                        imageElem.src = post.image_url.includes('?') 
                            ? post.image_url + '&t=' + new Date().getTime() 
                            : post.image_url + '?t=' + new Date().getTime();
                    }, 500);
                });
            }
            
            postElement.querySelector('.like-count').textContent = post.likes || 0;
            
            if (currentUser && (post.author_employee_id === currentUser.employee_id || isAdmin)) {
                postElement.querySelector('.delete-btn').classList.remove('hidden');
            }
            
            if (isAdmin) {
                if (post.is_pinned) {
                    postElement.querySelector('.unpin-btn').classList.remove('hidden');
                } else {
                    postElement.querySelector('.pin-btn').classList.remove('hidden');
                }
            }
            
            return postElement;
        }

        // é™„åŠ å¸–å­äº‹ä»¶
        function attachPostEvents() {
            // ç‚¹èµäº‹ä»¶
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    if (!currentUser) return;
                    
                    const postElement = event.currentTarget.closest('.post');
                    const postId = postElement.dataset.id;
                    
                    database.ref(`posts/${postId}/likes`).transaction((likes) => {
                        return (likes || 0) + 1;
                    });
                });
            });
            
            // åˆ é™¤äº‹ä»¶
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    if (!currentUser) return;
                    
                    const postElement = event.currentTarget.closest('.post');
                    const postId = postElement.dataset.id;
                    
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¸–å­å—ï¼Ÿ')) {
                        database.ref(`posts/${postId}`).remove()
                            .then(() => {
                                showToast('åˆ é™¤æˆåŠŸ');
                                
                                database.ref('replies').orderByChild('post_id').equalTo(postId).once('value', (snapshot) => {
                                    snapshot.forEach((childSnapshot) => {
                                        childSnapshot.ref.remove();
                                    });
                                });
                            })
                            .catch(error => {
                                console.error('åˆ é™¤å¤±è´¥:', error);
                                showToast('åˆ é™¤å¤±è´¥', false);
                            });
                    }
                });
            });
            
            // ç½®é¡¶äº‹ä»¶
            document.querySelectorAll('.pin-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    if (!isAdmin) return;
                    
                    const postElement = event.currentTarget.closest('.post');
                    const postId = postElement.dataset.id;
                    
                    database.ref(`posts/${postId}`).once('value').then((snapshot) => {
                        if (snapshot.exists()) {
                            const post = snapshot.val();
                            
                            database.ref(`posts/${postId}/is_pinned`).set(true)
                                .then(async () => {
                                    await addUserPoints(post.author_employee_id, 5, 'å¸–å­è¢«ç½®é¡¶');
                                    showToast('å¸–å­å·²ç½®é¡¶ï¼Œä½œè€…è·å¾—5ç§¯åˆ†å¥–åŠ±ï¼');
                                })
                                .catch(error => {
                                    console.error('ç½®é¡¶å¤±è´¥:', error);
                                    showToast('ç½®é¡¶å¤±è´¥', false);
                                });
                        }
                    });
                });
            });
            
            // å–æ¶ˆç½®é¡¶äº‹ä»¶
            document.querySelectorAll('.unpin-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    if (!isAdmin) return;
                    
                    const postElement = event.currentTarget.closest('.post');
                    const postId = postElement.dataset.id;
                    
                    database.ref(`posts/${postId}/is_pinned`).set(false)
                        .then(() => {
                            showToast('å·²å–æ¶ˆç½®é¡¶');
                        })
                        .catch(error => {
                            console.error('å–æ¶ˆç½®é¡¶å¤±è´¥:', error);
                            showToast('å–æ¶ˆç½®é¡¶å¤±è´¥', false);
                        });
                });
            });
            
            // å›å¤æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.reply-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    if (!currentUser) {
                        showToast('è¯·å…ˆç™»å½•', false);
                        return;
                    }
                    
                    const postElement = event.currentTarget.closest('.post');
                    const repliesSection = postElement.querySelector('.replies-section');
                    
                    if (repliesSection.classList.contains('hidden')) {
                        repliesSection.classList.remove('hidden');
                        loadRepliesForPost(postElement.dataset.id);
                    } else {
                        repliesSection.classList.add('hidden');
                    }
                });
            });
            
            // å‘é€å›å¤äº‹ä»¶
            document.querySelectorAll('.send-reply-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    if (!currentUser) return;
                    
                    const postElement = event.currentTarget.closest('.post');
                    const postId = postElement.dataset.id;
                    const replyInput = postElement.querySelector('.reply-input');
                    const content = replyInput.value.trim();
                    
                    if (!content) {
                        showToast('è¯·è¾“å…¥å›å¤å†…å®¹', false);
                        return;
                    }
                    
                    const replyId = generateId();
                    const newReply = {
                        id: replyId,
                        post_id: postId,
                        author_name: currentUser.name,
                        author_employee_id: currentUser.employee_id,
                        author_avatar: currentUser.avatar_url,
                        content: content,
                        is_admin: isAdmin,
                        created_at: new Date().toISOString()
                    };
                    
                    database.ref('replies/' + replyId).set(newReply)
                        .then(async () => {
                            await addUserPoints(currentUser.employee_id, 5, 'å›å¸–');
                            
                            replyInput.value = '';
                            showToast('å›å¤æˆåŠŸï¼Œè·å¾—5ç§¯åˆ†ï¼');
                        })
                        .catch(error => {
                            console.error('å›å¤å¤±è´¥:', error);
                            showToast('å›å¤å¤±è´¥: ' + error.message, false);
                        });
                });
            });
        }

        // åŠ è½½ç‰¹å®šå¸–å­çš„å›å¤
        function loadRepliesForPost(postId) {
            const postElements = document.querySelectorAll(`.post[data-id="${postId}"]`);
            
            database.ref('replies').orderByChild('post_id').equalTo(postId).once('value', (snapshot) => {
                const replies = [];
                snapshot.forEach((childSnapshot) => {
                    replies.push(childSnapshot.val());
                });
                
                replies.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                
                postElements.forEach(postElement => {
                    const repliesContainer = postElement.querySelector('.replies-container');
                    repliesContainer.innerHTML = '';
                    
                    if (replies.length === 0) {
                        repliesContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">æš‚æ— å›å¤</p>';
                    } else {
                        replies.forEach(reply => {
                            repliesContainer.appendChild(createReplyElement(reply));
                        });
                    }
                });
                
                attachReplyEvents();
            });
        }
        
        // æ›´æ–°æ‰€æœ‰å›å¤
        function updateAllReplies(snapshot) {
            const allReplies = {};
            snapshot.forEach(childSnapshot => {
                const reply = childSnapshot.val();
                if (!allReplies[reply.post_id]) {
                    allReplies[reply.post_id] = [];
                }
                allReplies[reply.post_id].push(reply);
            });
            
            for (const postId in allReplies) {
                const postElements = document.querySelectorAll(`.post[data-id="${postId}"]`);
                
                allReplies[postId].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                
                postElements.forEach(postElement => {
                    const repliesSection = postElement.querySelector('.replies-section');
                    if (!repliesSection.classList.contains('hidden')) {
                        const repliesContainer = postElement.querySelector('.replies-container');
                        repliesContainer.innerHTML = '';
                        
                        allReplies[postId].forEach(reply => {
                            repliesContainer.appendChild(createReplyElement(reply));
                        });
                    }
                });
            }
            
            attachReplyEvents();
        }
        
        // åˆ›å»ºå›å¤å…ƒç´ 
        function createReplyElement(reply) {
            const template = document.getElementById('replyTemplate');
            const replyElement = template.content.cloneNode(true).querySelector('.reply');
            
            replyElement.dataset.id = reply.id;
            
            const avatarElem = replyElement.querySelector('.reply-avatar');
            if (reply.author_avatar) {
                avatarElem.src = reply.author_avatar;
            }
            
            replyElement.querySelector('.reply-author').textContent = reply.author_name;
            
            if (reply.is_admin) {
                replyElement.querySelector('.reply-admin-badge').classList.remove('hidden');
            }
            
            const date = new Date(reply.created_at);
            replyElement.querySelector('.reply-time').textContent = date.toLocaleString();
            
            replyElement.querySelector('.reply-content').textContent = reply.content;
            
            if (currentUser && (reply.author_employee_id === currentUser.employee_id || isAdmin)) {
                replyElement.querySelector('.delete-reply-btn').classList.remove('hidden');
            }
            
            return replyElement;
        }
        
        // æ·»åŠ å›å¤ç›¸å…³äº‹ä»¶
        function attachReplyEvents() {
            document.querySelectorAll('.delete-reply-btn').forEach(btn => {
                btn.addEventListener('click', event => {
                    if (!currentUser) return;
                    
                    const replyElement = event.currentTarget.closest('.reply');
                    const replyId = replyElement.dataset.id;
                    
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¤å—ï¼Ÿ')) {
                        database.ref(`replies/${replyId}`).remove()
                            .then(() => {
                                showToast('åˆ é™¤å›å¤æˆåŠŸ');
                            })
                            .catch(error => {
                                console.error('åˆ é™¤å›å¤å¤±è´¥:', error);
                                showToast('åˆ é™¤å›å¤å¤±è´¥', false);
                            });
                    }
                });
            });
        }

        // æ›´æ–°å¤´åƒ
        async function updateAvatar() {
            if (!currentUser || !document.getElementById('avatarInput').files.length) return;
            
            showLoading(true);
            
            try {
                const file = document.getElementById('avatarInput').files[0];
                const compressedFile = await compressImage(file);
                const avatarUrl = await uploadImageToImgBB(compressedFile);
                
                if (!avatarUrl) {
                    showToast('å¤´åƒä¸Šä¼ å¤±è´¥', false);
                    return;
                }
                
                await database.ref(`users/${currentUser.employee_id}`).update({
                    avatar_url: avatarUrl
                });
                
                currentUser.avatar_url = avatarUrl;
                
                document.getElementById('profileAvatar').src = avatarUrl;
                document.getElementById('navUserAvatar').src = avatarUrl;
                showToast('å¤´åƒæ›´æ–°æˆåŠŸ');
                
                updatePostsWithNewAvatar(avatarUrl);
                updateRepliesWithNewAvatar(avatarUrl);
            } catch (error) {
                console.error('æ›´æ–°å¤´åƒå¤±è´¥:', error);
                showToast('æ›´æ–°å¤´åƒå¤±è´¥', false);
            } finally {
                showLoading(false);
            }
        }
        
        // æ›´æ–°ç”¨æˆ·æ‰€æœ‰å¸–å­ä¸­çš„å¤´åƒ
        function updatePostsWithNewAvatar(newAvatarUrl) {
            if (!currentUser) return;
            
            database.ref('posts').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')
                .then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        childSnapshot.ref.update({ author_avatar: newAvatarUrl });
                    });
                });
        }
        
        // æ›´æ–°ç”¨æˆ·æ‰€æœ‰å›å¤ä¸­çš„å¤´åƒ
        function updateRepliesWithNewAvatar(newAvatarUrl) {
            if (!currentUser) return;
            
            database.ref('replies').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')
                .then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        childSnapshot.ref.update({ author_avatar: newAvatarUrl });
                    });
                });
        }
        
        // æ›´æ–°ç”¨æˆ·æ‰€æœ‰å¸–å­ä¸­çš„å§“å
        function updatePostsWithNewName(newName) {
            if (!currentUser) return;
            
            database.ref('posts').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')
                .then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        childSnapshot.ref.update({ author_name: newName });
                    });
                });
        }
        
        // æ›´æ–°ç”¨æˆ·æ‰€æœ‰å›å¤ä¸­çš„å§“å
        function updateRepliesWithNewName(newName) {
            if (!currentUser) return;
            
            database.ref('replies').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')
                .then((snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        childSnapshot.ref.update({ author_name: newName });
                    });
                });
        }

        // æ·»åŠ åˆå§‹å¸–å­ï¼ˆå¦‚æœFirebaseä¸ºç©ºï¼‰
        function addInitialPostsIfNeeded() {
            database.ref('posts').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    console.log('æ•°æ®åº“ä¸ºç©ºï¼Œæ·»åŠ åˆå§‹å¸–å­');
                    const initialPosts = {
                        "init1": {
                            id: "init1",
                            author_name: "ç³»ç»Ÿç®¡ç†å‘˜",
                            author_employee_id: "admin001",
                            author_avatar: "https://via.placeholder.com/100",
                            content: "æ¬¢è¿ä½¿ç”¨é’å¹´Ï€ç©ºé—´ï¼è¿™æ˜¯ä¸€ä¸ªæŠ€æœ¯é—®é¢˜ç¤ºä¾‹å¸–å­ã€‚",
                            section: "tech",
                            is_admin: true,
                            is_pinned: false,
                            likes: 0,
                            created_at: new Date().toISOString()
                        },
                        "init2": {
                            id: "init2",
                            author_name: "ç³»ç»Ÿç®¡ç†å‘˜",
                            author_employee_id: "admin001",
                            author_avatar: "https://via.placeholder.com/100",
                            content: "åœ¨è¿™é‡Œå¯ä»¥åˆ†äº«æ—¥å¸¸é—®é¢˜å’Œäº¤æµã€‚",
                            section: "daily",
                            is_admin: true,
                            is_pinned: false,
                            likes: 0,
                            created_at: new Date().toISOString()
                        }
                    };
                    
                    database.ref('posts').set(initialPosts);
                }
            });
        }
    </script>
</body>
</html>
