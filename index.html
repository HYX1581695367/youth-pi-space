
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>装备部件团支部青年π空间</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen flex flex-col">
    <nav class="bg-blue-700 text-white shadow">
      <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <h1 class="text-2xl font-bold">装备部件团支部青年π空间</h1>
        <div id="userNav" class="hidden">
          <span id="navUserName"></span>
          <button class="bg-blue-500 px-3 py-1 rounded" id="editProfileBtn">编辑</button>
          <button class="bg-gray-500 px-3 py-1 rounded" id="logoutBtn">退出</button>
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-4 py-6 flex-grow">

      <!-- 登录界面 -->
      <div id="loginContainer" class="bg-white shadow-lg rounded-lg p-6 max-w-md mx-auto">
        <h2 class="text-center text-xl font-semibold mb-4">登录青年π空间</h2>
        <input id="loginEmployeeId" type="text" class="w-full border p-2 mb-3 rounded" placeholder="工号" />
        <input id="loginPassword" type="password" class="w-full border p-2 mb-4 rounded" placeholder="密码" />
        <button id="loginBtn" class="w-full bg-blue-600 text-white py-2 rounded">登录</button>
      </div>

      <!-- 主界面 -->
      <div id="mainContainer" class="hidden">
        <div class="flex space-x-2 mb-4 bg-white p-2 shadow rounded">
          <button data-section="tech" class="section-btn bg-blue-600 text-white px-4 py-2 rounded">技术板块</button>
          <button data-section="daily" class="section-btn bg-gray-200 px-4 py-2 rounded">日常板块</button>
          <button data-section="user" class="section-btn bg-gray-200 px-4 py-2 rounded">用户中心</button>
          <!-- === 新增积分功能开始 === -->
          <button data-section="points" class="section-btn bg-gray-200 px-4 py-2 rounded">积分排行榜</button>
          <!-- === 新增积分功能结束 === -->
          <button data-section="admin" class="section-btn hidden bg-gray-200 px-4 py-2 rounded" id="adminSectionBtn">管理员板块</button>
        </div>

        <!-- 技术板块 -->
        <div id="techSection" class="section-content">
          <h2 class="text-xl font-bold mb-2">技术讨论区</h2>
          <textarea id="techPostContent" class="w-full border p-2 rounded mb-2" placeholder="发表技术问题..."></textarea>
          <button id="techPostBtn" class="bg-blue-600 text-white px-3 py-1 rounded">发布</button>
          <div id="techPosts" class="mt-3 space-y-3"></div>
        </div>

        <!-- 日常板块 -->
        <div id="dailySection" class="section-content hidden">
          <h2 class="text-xl font-bold mb-2">日常交流区</h2>
          <textarea id="dailyPostContent" class="w-full border p-2 rounded mb-2" placeholder="分享你的日常..."></textarea>
          <button id="dailyPostBtn" class="bg-blue-600 text-white px-3 py-1 rounded">发布</button>
          <div id="dailyPosts" class="mt-3 space-y-3"></div>
        </div>

        <!-- 个人中心 -->
        <div id="userSection" class="section-content hidden">
          <h2 class="text-xl font-bold mb-3">个人中心</h2>
          <div class="bg-white shadow p-3 rounded">
            <p>姓名：<span id="profileName"></span></p>
            <p>工号：<span id="profileEmployeeId"></span></p>
            <p>当前积分：<span id="profilePoints">0</span> 分</p>
            <!-- === 新增积分功能开始 === -->
            <p id="profileRank"></p>
            <button id="signInBtn" class="mt-2 bg-green-500 text-white px-3 py-1 rounded">每日签到</button>
            <p id="signInStatus" class="text-gray-500"></p>
            <!-- === 新增积分功能结束 === -->
          </div>
        </div>

        <!-- === 新增积分功能开始 === -->
        <!-- 积分排行榜 -->
        <div id="pointsSection" class="section-content hidden">
          <h2 class="text-xl font-bold mb-3">积分排行榜</h2>
          <table class="w-full text-left bg-white border rounded shadow">
            <thead class="bg-gray-200">
              <tr><th class="p-2">排名</th><th class="p-2">姓名</th><th class="p-2">工号</th><th class="p-2">积分</th></tr>
            </thead>
            <tbody id="pointsTable"></tbody>
          </table>
        </div>
        <!-- === 新增积分功能结束 === -->

        <!-- 管理员板块：原完整管理员功能 + 优秀帖加分 -->
        <div id="adminSection" class="section-content hidden">
          <h2 class="text-xl font-bold mb-3">管理员面板</h2>
          <div id="adminPanel"></div>
          <!-- === 新增积分功能开始 === -->
          <div id="excellentPostsArea" class="mt-4">
            <h3 class="font-semibold text-lg mb-2">优秀帖子管理</h3>
            <div id="adminPosts" class="space-y-3"></div>
          </div>
          <!-- === 新增积分功能结束 === -->
        </div>
      </div>
    </main>
  </div>

  <script>
    // Firebase 初始化
    const firebaseConfig = {
      apiKey: "AIzaSyC19CX0gSWAzvFevy43EQRy4uX1A265LuM",
      authDomain: "youth-pi-space.firebaseapp.com",
      databaseURL: "https://youth-pi-space-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "youth-pi-space"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = null;

    // 页面加载初始化
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("loginBtn").addEventListener("click", login);
      document.getElementById("techPostBtn").addEventListener("click", () => createPost("tech"));
      document.getElementById("dailyPostBtn").addEventListener("click", () => createPost("daily"));
      document.querySelectorAll(".section-btn").forEach(b =>
        b.addEventListener("click", () => switchSection(b.dataset.section))
      );
      document.getElementById("signInBtn").addEventListener("click", signInToday);
    });

    // 登录逻辑
    function login() {
      const empId = document.getElementById("loginEmployeeId").value.trim();
      const pwd = document.getElementById("loginPassword").value.trim();
      if (!empId || !pwd) return alert("请输入完整信息");
      db.ref("users/" + empId).once("value").then(snap => {
        if (!snap.exists()) return alert("用户不存在");
        const data = snap.val();
        if (data.password !== pwd) return alert("密码错误");
        currentUser = data;
        document.getElementById("loginContainer").classList.add("hidden");
        document.getElementById("mainContainer").classList.remove("hidden");
        document.getElementById("navUserName").textContent = currentUser.name;
        document.getElementById("userNav").classList.remove("hidden");
        document.getElementById("profileName").textContent = data.name;
        document.getElementById("profileEmployeeId").textContent = data.employee_id;
        document.getElementById("profilePoints").textContent = data.points || 0;
        if (currentUser.is_admin) document.getElementById("adminSectionBtn").classList.remove("hidden");
        loadPosts();
        loadRanking();
        updateRankDisplay();
      });
    }

    // 切换区块
    function switchSection(section) {
      document.querySelectorAll(".section-btn").forEach(b => b.classList.remove("bg-blue-600", "text-white"));
      document.querySelector(`[data-section='${section}']`).classList.add("bg-blue-600","text-white");
      document.querySelectorAll(".section-content").forEach(c => c.classList.add("hidden"));
      document.getElementById(section + "Section").classList.remove("hidden");
      if (section === "points") loadRanking();
      if (section === "admin" && currentUser.is_admin) loadAdminPanel();
    }

    // === 新增积分功能开始 ===
    function addPoints(empId, amount, reason) {
      const ref = db.ref("users/" + empId + "/points");
      ref.transaction(cur => (cur || 0) + amount);
    }

    function signInToday() {
      const today = new Date().toISOString().split("T")[0];
      const ref = db.ref("users/" + currentUser.employee_id);
      ref.once("value").then(snap => {
        const data = snap.val();
        if (data.last_signin === today) {
          document.getElementById("signInStatus").textContent = "今日已签到";
          return;
        }
        ref.update({ last_signin: today });
        addPoints(currentUser.employee_id, 5, "每日签到");
        alert("签到成功 +5 积分");
        updateProfilePoints();
        loadRanking();
      });
    }

    function updateProfilePoints() {
      db.ref("users/" + currentUser.employee_id + "/points").once("value")
        .then(s => document.getElementById("profilePoints").textContent = s.val() || 0);
      updateRankDisplay();
    }

    function loadRanking() {
      db.ref("users").once("value").then(snap => {
        const users = [];
        snap.forEach(s => users.push(s.val()));
        users.sort((a,b) => (b.points || 0) - (a.points || 0));
        const tb = document.getElementById("pointsTable");
        tb.innerHTML="";
        users.forEach((u,i)=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td class="p-2">${i+1}</td><td class="p-2">${u.name}</td><td class="p-2">${u.employee_id}</td><td class="p-2">${u.points||0}</td>`;
          tb.appendChild(tr);
        });
      });
    }

    function updateRankDisplay() {
      db.ref("users").once("value").then(snap=>{
        const arr=[]; snap.forEach(s=>arr.push(s.val()));
        arr.sort((a,b)=>(b.points||0)-(a.points||0));
        const index=arr.findIndex(x=>x.employee_id===currentUser.employee_id);
        if(index!==-1){
          document.getElementById("profileRank").textContent=`当前排名：第 ${index+1} 名`;
        }
      });
    }
    // === 新增积分功能结束 ===

    // 发帖逻辑
    function createPost(section){
      const content=document.getElementById(section+"PostContent").value.trim();
      if(!content) return alert("请输入内容");
      const id=Date.now().toString();
      const post={
        id,section,content,
        author:currentUser.name,
        employee_id:currentUser.employee_id,
        created_at:new Date().toISOString(),
        is_excellent:false
      };
      db.ref("posts/"+id).set(post).then(()=>{
        document.getElementById(section+"PostContent").value="";
        loadPosts();
        addPoints(currentUser.employee_id,5,"发帖");
      });
    }

    // 加载帖子与回复
    function loadPosts(){
      db.ref("posts").on("value",snap=>{
        document.getElementById("techPosts").innerHTML="";
        document.getElementById("dailyPosts").innerHTML="";
        snap.forEach(p=>{
          const post=p.val();
          const div=document.createElement("div");
          div.className="bg-white p-3 rounded shadow";
          const head=post.is_excellent?"⭐":"";
          div.innerHTML=`<p><strong>${head}${post.author}</strong>：${post.content}</p><p class="text-gray-500 text-sm">${new Date(post.created_at).toLocaleString()}</p>`;
          const replyInput=document.createElement("input");
          replyInput.className="border p-1 w-full mt-2 rounded";
          replyInput.placeholder="回复...";
          const replyBtn=document.createElement("button");
          replyBtn.className="mt-1 bg-blue-500 text-white px-3 py-1 rounded";
          replyBtn.textContent="回复";
          replyBtn.onclick=()=>{
            const reply=replyInput.value.trim();
            if(!reply)return;
            const rid=Date.now().toString();
            db.ref("posts/"+post.id+"/replies/"+rid).set({
              author:currentUser.name,
              content:reply,
              created_at:new Date().toISOString()
            }).then(()=>{
              replyInput.value="";
              if(post.section==="tech") addPoints(currentUser.employee_id,4,"技术区回复");
              else addPoints(currentUser.employee_id,2,"日常区回复");
            });
          };
          div.appendChild(replyInput);
          div.appendChild(replyBtn);
          if(currentUser.is_admin){
            const exBtn=document.createElement("button");
            exBtn.textContent="设为优秀";
            exBtn.className="ml-2 bg-yellow-500 text-white px-3 py-1 rounded";
            exBtn.onclick=()=>markExcellent(post);
            div.appendChild(exBtn);
          }
          (post.section==="tech"?document.getElementById("techPosts"):document.getElementById("dailyPosts")).appendChild(div);
        });
      });
    }

    // === 新增积分功能开始 ===
    function markExcellent(post){
      db.ref("posts/"+post.id+"/is_excellent").set(true);
      addPoints(post.employee_id,10,"优秀帖加分");
      alert("设置成功，为作者 +10 积分");
    }

    function loadAdminPanel(){
      const box=document.getElementById("adminPosts");
      box.innerHTML="";
      db.ref("posts").once("value").then(snap=>{
        snap.forEach(p=>{
          const post=p.val();
          const div=document.createElement("div");
          div.className="bg-white p-3 rounded shadow";
          div.innerHTML=`<p><strong>${post.author}</strong>：${post.content}</p>`;
          if(!post.is_excellent){
            const btn=document.createElement("button");
            btn.textContent="设为优秀";
            btn.className="bg-yellow-500 text-white px-3 py-1 rounded mt-1";
            btn.onclick=()=>markExcellent(post);
            div.appendChild(btn);
          }else{
            div.innerHTML+="<p class='text-yellow-600'>⭐ 已为优秀帖</p>";
          }
          box.appendChild(div);
        });
      });
    }
    // === 新增积分功能结束 ===
  </script>
</body>
</html>
