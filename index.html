<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>装备部件团支部青年π空间</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    
    <!-- Firebase SDK -->  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>  
    
    <!-- 密码哈希库 -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>  
    
    <!-- 改进的样式 -->  
    <style>  
        .hidden {  
            display: none !important;  
        }  
        
        @media (max-width: 768px) {  
            .post-image-container:not(.hidden) {  
                display: block;  
                width: 100%;  
            }  
            
            .post-image {  
                max-width: 100%;  
                height: auto;  
                max-height: 300px !important;  
                object-fit: contain;  
            }  
        }  
    </style>  
</head>  
<body class="bg-gray-100">  
    <div class="min-h-screen flex flex-col">  
        <!-- 导航栏 -->  
        <nav class="bg-blue-600 text-white shadow-lg">  
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">  
                <h1 class="text-2xl font-bold">装备部件团支部青年π空间</h1>  
                <div id="userNav" class="hidden">  
                    <div class="flex items-center space-x-3">  
                        <img id="navUserAvatar" class="w-8 h-8 rounded-full object-cover" src="https://via.placeholder.com/32" alt="用户头像">  
                        <span id="navUserName">加载中...</span>  
                        <button id="editProfileBtn" class="px-3 py-1 bg-blue-500 rounded hover:bg-blue-600">编辑信息</button>  
                        <!-- 管理员设置按钮，只对管理员可见 -->  
                        <button id="adminPanelBtn" class="hidden px-3 py-1 bg-red-500 rounded hover:bg-red-600">管理员设置</button>  
                        <button id="logoutBtn" class="px-3 py-1 bg-gray-500 rounded hover:bg-gray-600">退出登录</button>  
                    </div>  
                </div>  
            </div>  
        </nav>  

        <!-- 主内容区 -->  
        <div class="container mx-auto px-4 py-6 flex-grow">  
            <!-- 登录表单 -->  
            <div id="loginContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10">  
                <h2 class="text-xl font-semibold mb-4 text-center">登录青年π空间</h2>  
                <p class="text-gray-600 mb-6 text-center">请输入您的工号和密码</p>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">工号</label>  
                        <input id="loginEmployeeId" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入工号">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">密码</label>  
                        <input id="loginPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入密码">  
                    </div>  
                    <div class="flex justify-center">  
                        <button id="loginBtn" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">登录</button>  
                    </div>  
                    <div class="text-center">  
                        <p class="text-gray-600">首次使用? <button id="showRegisterBtn" class="text-blue-500 hover:underline">注册新账号</button></p>  
                    </div>  
                </div>  
            </div>  

            <!-- 注册表单 -->  
            <div id="registerContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10 hidden">  
                <h2 class="text-xl font-semibold mb-4 text-center">注册新账号</h2>  
                <p class="text-gray-600 mb-6 text-center">首次使用工号需要注册</p>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">姓名</label>  
                        <input id="registerName" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入姓名">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">工号</label>  
                        <input id="registerEmployeeId" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入工号">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">设置密码</label>  
                        <input id="registerPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请设置密码">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">确认密码</label>  
                        <input id="confirmPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请再次输入密码">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">头像</label>  
                        <input id="registerAvatar" type="file" accept="image/*" class="w-full">  
                    </div>  
                    <div class="flex justify-center">  
                        <button id="registerBtn" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">注册账号</button>  
                    </div>  
                    <div class="text-center">  
                        <p class="text-gray-600">已有账号? <button id="showLoginBtn" class="text-blue-500 hover:underline">返回登录</button></p>  
                    </div>  
                </div>  
            </div>  

            <!-- 修改用户信息表单 -->  
            <div id="userInfoContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10 hidden">  
                <h2 class="text-xl font-semibold mb-4 text-center">编辑个人信息</h2>  
                <p class="text-gray-600 mb-6 text-center">您可以修改个人信息</p>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">姓名</label>  
                        <input id="userName" type="text" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请输入姓名">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">头像</label>  
                        <input id="userAvatar" type="file" accept="image/*" class="w-full">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">修改密码 (留空则不修改)</label>  
                        <input id="newPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入新密码">  
                    </div>  
                    <div>  
                        <label class="block text-gray-700 mb-1">确认新密码</label>  
                        <input id="confirmNewPassword" type="password" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="再次输入新密码">  
                    </div>  
                    <div class="flex justify-center space-x-3">  
                        <button id="saveUserInfoBtn" class="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">保存修改</button>  
                        <button id="cancelEditBtn" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">取消</button>  
                    </div>  
                </div>  
            </div>  

            <!-- 管理员面板 -->  
            <div id="adminPanelContainer" class="bg-white shadow-md rounded-lg p-6 max-w-md mx-auto my-10 hidden">  
                <h2 class="text-xl font-semibold mb-4 text-center">管理员设置</h2>  
                <div class="space-y-4">  
                    <div>  
                        <label class="block text-gray-700 mb-1">添加管理员工号</label>  
                        <div class="flex">  
                            <input id="newAdminId" type="text" class="flex-grow px-4 py-2 border rounded-l focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入工号">  
                            <button id="addAdminBtn" class="px-4 py-2 bg-blue-500 text-white rounded-r hover:bg-blue-600">添加</button>  
                        </div>  
                    </div>  
                    <div>  
                        <h3 class="text-lg font-semibold mb-2">当前管理员列表</h3>  
                        <div id="adminList" class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded">  
                            <p class="text-gray-500 text-center">加载中...</p>  
                        </div>  
                    </div>  
                    <div class="flex justify-center">  
                        <button id="closeAdminPanelBtn" class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">关闭</button>  
                    </div>  
                </div>  
            </div>  

            <!-- 主要内容区 -->  
            <div id="mainContainer" class="hidden">  
                <!-- 板块导航 -->  
                <div class="bg-white shadow-md rounded-lg p-4 mb-6">  
                    <div class="flex space-x-4">  
                        <button data-section="tech" class="section-btn px-4 py-2 rounded bg-blue-500 text-white">技术问题板块</button>  
                        <button data-section="daily" class="section-btn px-4 py-2 rounded bg-gray-200">日常问题板块</button>  
                        <button data-section="user" class="section-btn px-4 py-2 rounded bg-gray-200">用户板块</button>  
                    </div>  
                </div>  

                <!-- 技术问题和日常问题板块 -->  
                <div id="techSection" class="section-content">  
                    <h2 class="text-xl font-bold mb-4">技术问题板块</h2>  
                    <div class="post-form bg-white shadow-md rounded-lg p-4 mb-6">  
                        <textarea id="techPostContent" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" rows="3" placeholder="分享你的技术问题..."></textarea>  
                        <div class="flex items-center mb-3">  
                            <label class="mr-2 text-gray-600">添加图片:</label>  
                            <input id="techPostImage" type="file" accept="image/*">  
                        </div>  
                        <button id="techPostBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">发布</button>  
                    </div>  
                    <div id="techPosts" class="space-y-6"></div>  
                </div>  

                <div id="dailySection" class="section-content hidden">  
                    <h2 class="text-xl font-bold mb-4">日常问题板块</h2>  
                    <div class="post-form bg-white shadow-md rounded-lg p-4 mb-6">  
                        <textarea id="dailyPostContent" class="w-full p-3 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" rows="3" placeholder="分享你的日常问题..."></textarea>  
                        <div class="flex items-center mb-3">  
                            <label class="mr-2 text-gray-600">添加图片:</label>  
                            <input id="dailyPostImage" type="file" accept="image/*">  
                        </div>  
                        <button id="dailyPostBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">发布</button>  
                    </div>  
                    <div id="dailyPosts" class="space-y-6"></div>  
                </div>  

                <!-- 用户板块 -->  
                <div id="userSection" class="section-content hidden">  
                    <h2 class="text-xl font-bold mb-4">个人中心</h2>  
                    <div class="bg-white shadow-md rounded-lg p-6 mb-6">  
                        <div class="flex items-center space-x-4 mb-6">  
                            <div class="relative group">  
                                <img id="profileAvatar" class="w-20 h-20 rounded-full object-cover" src="https://via.placeholder.com/80" alt="用户头像">  
                                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" id="changeAvatarBtn">  
                                    <span class="text-white text-xs">更换头像</span>  
                                </div>  
                                <input type="file" id="avatarInput" class="hidden" accept="image/*">  
                            </div>  
                            <div>  
                                <h3 id="profileName" class="text-xl font-semibold">加载中...</h3>  
                                <p class="text-gray-600">工号: <span id="profileEmployeeId">加载中...</span></p>  
                                <p id="adminBadge" class="hidden text-xs bg-red-500 text-white px-2 py-0.5 rounded inline-block mt-1">管理员</p>  
                            </div>  
                        </div>  
                    </div>  

                    <h3 class="text-lg font-semibold mb-3">我的发布记录</h3>  
                    <div id="userPosts" class="space-y-6"></div>  
                </div>  
            </div>  
        </div>  
        
        <!-- 页脚 -->  
        <footer class="bg-gray-800 text-white py-4 mt-auto">  
            <div class="container mx-auto px-4 text-center">  
                <p>装备部件团支部青年π空间 &copy; 2025</p>  
            </div>  
        </footer>  
    </div>  

    <!-- 状态提示 -->  
    <div id="statusToast" class="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transform transition-transform duration-300 translate-y-20 opacity-0">  
        操作成功  
    </div>  

    <!-- 数据加载中遮罩 -->  
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">  
        <div class="bg-white p-4 rounded-lg shadow-lg text-center">  
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-2"></div>  
            <p>加载中，请稍候...</p>  
        </div>  
    </div>  

    <!-- 模板 -->  
    <template id="postTemplate">  
        <div class="post bg-white shadow-md rounded-lg p-4">  
            <div class="flex items-start space-x-3 mb-3">  
                <img class="post-avatar w-10 h-10 rounded-full object-cover" src="https://via.placeholder.com/40" alt="用户头像">  
                <div class="flex-grow">  
                    <div class="flex items-center space-x-2">  
                        <h3 class="post-author font-semibold"></h3>  
                        <span class="post-admin-badge hidden text-xs bg-red-500 text-white px-1 rounded">管理员</span>  
                    </div>  
                    <p class="post-time text-gray-500 text-sm"></p>  
                </div>  
            </div>  
            <p class="post-content mb-3"></p>  
            <!-- 修改为原版的图片容器 -->  
            <div class="post-image-container mb-3 hidden">  
                <img class="post-image max-h-96 w-full object-contain rounded" alt="发布的图片">  
            </div>  
            <div class="flex items-center space-x-4 text-gray-500 mb-3">  
                <button class="like-btn flex items-center space-x-1 hover:text-blue-500">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">  
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />  
                    </svg>  
                    <span class="like-count">0</span>  
                </button>  
                <button class="reply-btn flex items-center space-x-1 hover:text-blue-500">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">  
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />  
                    </svg>  
                    <span>回复</span>  
                </button>  
                <button class="delete-btn hidden text-red-500 hover:text-red-700">删除</button>  
            </div>  
            
            <!-- 回复区域 -->  
            <div class="replies-section mt-2 border-t pt-2 hidden">  
                <div class="reply-form mb-3">  
                    <div class="flex">  
                        <input type="text" class="reply-input flex-grow px-3 py-1 border rounded-l focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="回复这条消息...">  
                        <button class="send-reply-btn px-3 py-1 bg-blue-500 text-white rounded-r hover:bg-blue-600">发送</button>  
                    </div>  
                </div>  
                <div class="replies-container space-y-2"></div>  
            </div>  
        </div>  
    </template>  

    <!-- 回复模板 -->  
    <template id="replyTemplate">  
        <div class="reply bg-gray-50 p-2 rounded">  
            <div class="flex items-start">  
                <img class="reply-avatar w-6 h-6 rounded-full object-cover mr-2" src="https://via.placeholder.com/24" alt="回复者头像">  
                <div class="flex-grow">  
                    <div class="flex items-center">  
                        <span class="reply-author font-medium text-sm mr-1"></span>  
                        <span class="reply-admin-badge hidden text-xs bg-red-500 text-white px-1 rounded">管理员</span>  
                        <span class="reply-time text-gray-400 text-xs ml-auto"></span>  
                    </div>  
                    <p class="reply-content text-sm"></p>  
                </div>  
                <button class="delete-reply-btn hidden text-red-500 hover:text-red-700 text-xs ml-2">删除</button>  
            </div>  
        </div>  
    </template>  

    <!-- 管理员项模板 -->  
    <template id="adminItemTemplate">  
        <div class="admin-item flex items-center justify-between p-2 bg-gray-100 rounded">  
            <span class="admin-id font-medium"></span>  
            <button class="remove-admin-btn text-red-500 hover:text-red-700 text-sm">移除</button>  
        </div>  
    </template>  

    <script>  
        // Firebase 配置  
        const firebaseConfig = {  
            apiKey: "AIzaSyC19CX0gSWAzvFevy43EQRy4uX1A265LuM",  
            authDomain: "youth-pi-space.firebaseapp.com",  
            databaseURL: "https://youth-pi-space-default-rtdb.asia-southeast1.firebasedatabase.app",  
            projectId: "youth-pi-space",  
            storageBucket: "youth-pi-space.firebasestorage.app",  
            messagingSenderId: "895213716516",  
            appId: "1:895213716516:web:9548b7964aaf3074b504b1"  
        };  
        
        // 初始化 Firebase  
        firebase.initializeApp(firebaseConfig);  
        const database = firebase.database();  
        
        // 当前用户对象  
        let currentUser = null;  
        let isAdmin = false;  
        
        // 是否已加载过帖子的标志，避免重复处理  
        let postsInitialized = false;  

        // 显示/隐藏加载遮罩  
        function showLoading(show = true) {  
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);  
        }  

        // 状态提示  
        function showToast(message, isSuccess = true) {  
            const toast = document.getElementById('statusToast');  
            toast.textContent = message;  
            toast.classList.remove('translate-y-20', 'opacity-0');  
            toast.classList.add('translate-y-0', 'opacity-100');  
            
            if (isSuccess) {  
                toast.classList.remove('bg-red-500');  
                toast.classList.add('bg-green-500');  
            } else {  
                toast.classList.remove('bg-green-500');  
                toast.classList.add('bg-red-500');  
            }  
            
            setTimeout(() => {  
                toast.classList.remove('translate-y-0', 'opacity-100');  
                toast.classList.add('translate-y-20', 'opacity-0');  
            }, 3000);  
        }  

        // 生成密码哈希  
        function hashPassword(password, salt = null) {  
            if (!salt) {  
                // 生成随机盐值  
                salt = CryptoJS.lib.WordArray.random(128/8).toString();  
            }  
            
            // 使用盐值创建PBKDF2哈希  
            const hash = CryptoJS.PBKDF2(password, salt, {  
                keySize: 512/32,  
                iterations: 1000  
            }).toString();  
            
            // 返回格式: salt:hash  
            return salt + ":" + hash;  
        }  
        
        // 验证密码  
        function verifyPassword(password, storedHash) {  
            const [salt, hash] = storedHash.split(":");  
            const calculatedHash = hashPassword(password, salt);  
            return calculatedHash === storedHash;  
        }  

        // 页面加载完成后初始化  
        document.addEventListener('DOMContentLoaded', () => {  
            console.log('页面加载完成');  
            
            // 初始化管理员列表  
            initializeAdminList();  
            
            // 检查登录状态  
            checkLoginStatus();  

            // 登录和注册表单切换按钮  
            document.getElementById('showRegisterBtn').addEventListener('click', () => {  
                document.getElementById('loginContainer').classList.add('hidden');  
                document.getElementById('registerContainer').classList.remove('hidden');  
            });  
            
            document.getElementById('showLoginBtn').addEventListener('click', () => {  
                document.getElementById('registerContainer').classList.add('hidden');  
                document.getElementById('loginContainer').classList.remove('hidden');  
            });  
            
            // 登录按钮  
            document.getElementById('loginBtn').addEventListener('click', login);  
            
            // 注册按钮  
            document.getElementById('registerBtn').addEventListener('click', register);  
            
            // 退出登录按钮  
            document.getElementById('logoutBtn').addEventListener('click', logout);  
            
            // 编辑信息按钮  
            document.getElementById('editProfileBtn').addEventListener('click', showEditProfileForm);  
            document.getElementById('cancelEditBtn').addEventListener('click', hideEditProfileForm);  
            
            // 保存用户信息按钮  
            document.getElementById('saveUserInfoBtn').addEventListener('click', updateUserInfo);  

            // 管理员面板按钮  
            document.getElementById('adminPanelBtn').addEventListener('click', showAdminPanel);  
            document.getElementById('closeAdminPanelBtn').addEventListener('click', hideAdminPanel);  
            document.getElementById('addAdminBtn').addEventListener('click', addNewAdmin);  

            // 板块切换  
            document.querySelectorAll('.section-btn').forEach(btn => {  
                btn.addEventListener('click', () => {  
                    const sectionId = btn.dataset.section;  
                    
                    // 更新按钮样式  
                    document.querySelectorAll('.section-btn').forEach(b => {  
                        if (b.dataset.section === sectionId) {  
                            b.classList.add('bg-blue-500', 'text-white');  
                            b.classList.remove('bg-gray-200');  
                        } else {  
                            b.classList.remove('bg-blue-500', 'text-white');  
                            b.classList.add('bg-gray-200');  
                        }  
                    });  
                    
                    // 显示对应板块内容  
                    document.querySelectorAll('.section-content').forEach(content => {  
                        content.classList.add('hidden');  
                        if (content.id === `${sectionId}Section`) {  
                            content.classList.remove('hidden');  
                        }  
                    });  
                });  
            });  

            // 发布帖子  
            document.getElementById('techPostBtn').addEventListener('click', () => createPost('tech'));  
            document.getElementById('dailyPostBtn').addEventListener('click', () => createPost('daily'));  

            // 更换头像  
            document.getElementById('changeAvatarBtn').addEventListener('click', () =>   
                document.getElementById('avatarInput').click()  
            );  
            document.getElementById('avatarInput').addEventListener('change', updateAvatar);  
        });  
        
        // 检查登录状态  
        function checkLoginStatus() {  
            const sessionData = localStorage.getItem('userSession');  
            if (sessionData) {  
                try {  
                    const session = JSON.parse(sessionData);  
                    // 验证会话是否过期  
                    const now = new Date().getTime();  
                    if (session.expires > now) {  
                        // 会话有效，从Firebase获取最新用户数据  
                        database.ref(`users/${session.employee_id}`).once('value').then((snapshot) => {  
                            if (snapshot.exists()) {  
                                currentUser = snapshot.val();  
                                checkAndUpdateAdminStatus();  
                                
                                // 设置帖子监听和加载初始数据  
                                addInitialPostsIfNeeded();  
                                setupRealTimeListeners();  
                                
                                showMainUI();  
                            } else {  
                                // 用户数据不存在，可能被删除  
                                logout();  
                            }  
                        });  
                    } else {  
                        // 会话过期  
                        logout();  
                    }  
                } catch (error) {  
                    console.error('解析会话数据出错:', error);  
                    logout();  
                }  
            } else {  
                // 显示登录表单  
                document.getElementById('loginContainer').classList.remove('hidden');  
                document.getElementById('mainContainer').classList.add('hidden');  
                document.getElementById('adminPanelContainer').classList.add('hidden');  
                document.getElementById('userInfoContainer').classList.add('hidden');  
                document.getElementById('userNav').classList.add('hidden');  
            }  
        }  
        
        // 登录  
        function login() {  
            const employeeId = document.getElementById('loginEmployeeId').value.trim();  
            const password = document.getElementById('loginPassword').value;  
            
            if (!employeeId || !password) {  
                showToast('请输入工号和密码', false);  
                return;  
            }  
            
            showLoading(true);  
            
            // 检查工号是否存在  
            database.ref(`users/${employeeId}`).once('value').then((snapshot) => {  
                if (snapshot.exists()) {  
                    const userData = snapshot.val();  
                    
                    // 验证密码  
                    if (verifyPassword(password, userData.password_hash)) {  
                        // 密码正确，创建会话  
                        currentUser = userData;  
                        
                        // 创建会话，设置24小时过期  
                        const session = {  
                            employee_id: employeeId,  
                            expires: new Date().getTime() + (24 * 60 * 60 * 1000) // 24小时后过期  
                        };  
                        localStorage.setItem('userSession', JSON.stringify(session));  
                        
                        // 检查管理员状态  
                        checkAndUpdateAdminStatus();  
                        
                        // 清空登录表单  
                        document.getElementById('loginEmployeeId').value = '';  
                        document.getElementById('loginPassword').value = '';  
                        
                        // 设置帖子监听和加载初始数据  
                        addInitialPostsIfNeeded();  
                        setupRealTimeListeners();  
                        
                        showMainUI();  
                        showToast('登录成功');  
                    } else {  
                        showToast('密码错误', false);  
                    }  
                } else {  
                    showToast('该工号尚未注册', false);  
                }  
                showLoading(false);  
            }).catch(error => {  
                console.error('登录出错:', error);  
                showToast('登录失败: ' + error.message, false);  
                showLoading(false);  
            });  
        }  
        
        // 注册  
        async function register() {  
            const name = document.getElementById('registerName').value.trim();  
            const employeeId = document.getElementById('registerEmployeeId').value.trim();  
            const password = document.getElementById('registerPassword').value;  
            const confirmPassword = document.getElementById('confirmPassword').value;  
            const avatarFile = document.getElementById('registerAvatar').files[0];  
            
            if (!name || !employeeId || !password) {  
                showToast('请填写所有必填字段', false);  
                return;  
            }  
            
            if (password !== confirmPassword) {  
                showToast('两次输入的密码不一致', false);  
                return;  
            }  
            
            if (password.length < 6) {  
                showToast('密码长度至少6位', false);  
                return;  
            }  
            
            showLoading(true);  
            
            try {  
                // 检查工号是否已存在  
                const snapshot = await database.ref(`users/${employeeId}`).once('value');  
                if (snapshot.exists()) {  
                    showToast('该工号已被注册', false);  
                    showLoading(false);  
                    return;  
                }  
                
                // 处理头像  
                let avatarUrl = 'https://via.placeholder.com/100';  
                if (avatarFile) {  
                    const compressedFile = await compressImage(avatarFile);  
                    avatarUrl = await uploadImageToImgBB(compressedFile);  
                    if (!avatarUrl) {  
                        showToast('头像上传失败，使用默认头像', false);  
                        avatarUrl = 'https://via.placeholder.com/100';  
                    }  
                }  
                
                // 创建用户对象  
                const userId = generateId();  
                const passwordHash = hashPassword(password);  
                
                const newUser = {  
                    id: userId,  
                    name: name,  
                    employee_id: employeeId,  
                    password_hash: passwordHash,  
                    avatar_url: avatarUrl,  
                    created_at: new Date().toISOString()  
                };  
                
                // 保存到Firebase  
                await database.ref(`users/${employeeId}`).set(newUser);  
                
                // 清空注册表单  
                document.getElementById('registerName').value = '';  
                document.getElementById('registerEmployeeId').value = '';  
                document.getElementById('registerPassword').value = '';  
                document.getElementById('confirmPassword').value = '';  
                document.getElementById('registerAvatar').value = '';  
                
                showToast('注册成功，请登录');  
                
                // 显示登录表单  
                document.getElementById('registerContainer').classList.add('hidden');  
                document.getElementById('loginContainer').classList.remove('hidden');  
            } catch (error) {  
                console.error('注册失败:', error);  
                showToast('注册失败: ' + error.message, false);  
            } finally {  
                showLoading(false);  
            }  
        }  
        
        // 退出登录  
        function logout() {  
            // 清除会话  
            localStorage.removeItem('userSession');  
            currentUser = null;  
            isAdmin = false;  
            
            // 重置标志  
            postsInitialized = false;  
            
            // 移除实时监听器  
            database.ref('posts').off();  
            database.ref('replies').off();  
            
            // 显示登录表单  
            document.getElementById('loginContainer').classList.remove('hidden');  
            document.getElementById('mainContainer').classList.add('hidden');  
            document.getElementById('adminPanelContainer').classList.add('hidden');  
            document.getElementById('userInfoContainer').classList.add('hidden');  
            document.getElementById('userNav').classList.add('hidden');  
            
            showToast('已退出登录');  
        }  
        
        // 显示编辑个人信息表单  
        function showEditProfileForm() {  
            if (!currentUser) return;  
            
            document.getElementById('mainContainer').classList.add('hidden');  
            document.getElementById('userInfoContainer').classList.remove('hidden');  
            
            // 填充表单  
            document.getElementById('userName').value = currentUser.name;  
        }  
        
        // 隐藏编辑个人信息表单  
        function hideEditProfileForm() {  
            document.getElementById('userInfoContainer').classList.add('hidden');  
            document.getElementById('mainContainer').classList.remove('hidden');  
        }  
        
        // 更新用户信息  
        async function updateUserInfo() {  
            if (!currentUser) return;  
            
            const name = document.getElementById('userName').value.trim();  
            const newPassword = document.getElementById('newPassword').value;  
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;  
            const avatarFile = document.getElementById('userAvatar').files[0];  
            
            if (!name) {  
                showToast('姓名不能为空', false);  
                return;  
            }  
            
            // 检查密码  
            if (newPassword) {  
                if (newPassword.length < 6) {  
                    showToast('密码长度至少6位', false);  
                    return;  
                }  
                
                if (newPassword !== confirmNewPassword) {  
                    showToast('两次输入的密码不一致', false);  
                    return;  
                }  
            }  
            
            showLoading(true);  
            
            try {  
                // 更新对象  
                const updates = {  
                    name: name  
                };  
                
                // 如果有密码更新  
                if (newPassword) {  
                    updates.password_hash = hashPassword(newPassword);  
                }  
                
                // 如果有头像更新  
                if (avatarFile) {  
                    const compressedFile = await compressImage(avatarFile);  
                    const avatarUrl = await uploadImageToImgBB(compressedFile);  
                    if (avatarUrl) {  
                        updates.avatar_url = avatarUrl;  
                    }  
                }  
                
                // 更新到Firebase  
                await database.ref(`users/${currentUser.employee_id}`).update(updates);  
                
                // 更新本地对象  
                Object.assign(currentUser, updates);  
                
                // 如果更新了头像，同时更新帖子和回复中的头像  
                if (avatarFile && updates.avatar_url) {  
                    updatePostsWithNewAvatar(updates.avatar_url);  
                    updateRepliesWithNewAvatar(updates.avatar_url);  
                }  
                
                // 如果更新了姓名，同时更新帖子和回复中的姓名  
                if (name !== currentUser.name) {  
                    updatePostsWithNewName(name);  
                    updateRepliesWithNewName(name);  
                }  
                
                // 清空表单  
                document.getElementById('newPassword').value = '';  
                document.getElementById('confirmNewPassword').value = '';  
                document.getElementById('userAvatar').value = '';  
                
                hideEditProfileForm();  
                showMainUI();  
                showToast('个人信息更新成功');  
            } catch (error) {  
                console.error('更新失败:', error);  
                showToast('更新失败: ' + error.message, false);  
            } finally {  
                showLoading(false);  
            }  
        }  

        // 初始化管理员列表  
        function initializeAdminList() {  
            // 检查管理员列表是否存在，如果不存在则初始化  
            database.ref('admins').once('value').then((snapshot) => {  
                if (!snapshot.exists()) {  
                    // 创建默认管理员列表  
                    const defaultAdmins = {  
                        'admin001': true,   
                        'admin002': true  
                    };  
                    database.ref('admins').set(defaultAdmins);  
                }  
                
                // 设置管理员列表变化监听  
                database.ref('admins').on('value', (snapshot) => {  
                    updateAdminList(snapshot);  
                    
                    // 如果当前用户已登录，更新其管理员状态  
                    if (currentUser) {  
                        checkAndUpdateAdminStatus();  
                    }  
                });  
            });  
        }  
        
        // 更新管理员列表UI  
        function updateAdminList(snapshot) {  
            const adminList = document.getElementById('adminList');  
            adminList.innerHTML = '';  
            
            if (!snapshot.exists()) {  
                adminList.innerHTML = '<p class="text-gray-500 text-center">暂无管理员</p>';  
                return;  
            }  
            
            const admins = [];  
            snapshot.forEach((childSnapshot) => {  
                admins.push(childSnapshot.key);  
            });  
            
            if (admins.length === 0) {  
                adminList.innerHTML = '<p class="text-gray-500 text-center">暂无管理员</p>';  
                return;  
            }  
            
            // 按字母顺序排序  
            admins.sort();  
            
            // 添加到UI  
            const template = document.getElementById('adminItemTemplate');  
            
            admins.forEach(adminId => {  
                const adminElement = template.content.cloneNode(true).querySelector('.admin-item');  
                adminElement.querySelector('.admin-id').textContent = adminId;  
                
                // 添加移除管理员事件  
                adminElement.querySelector('.remove-admin-btn').addEventListener('click', () => {  
                    removeAdmin(adminId);  
                });  
                
                adminList.appendChild(adminElement);  
            });  
        }  
        
        // 添加新管理员  
        function addNewAdmin() {  
            if (!isAdmin) {  
                showToast('只有管理员可以添加其他管理员', false);  
                return;  
            }  
            
            const newAdminId = document.getElementById('newAdminId').value.trim();  
            if (!newAdminId) {  
                showToast('请输入工号', false);  
                return;  
            }  
            
            // 检查是否已经是管理员  
            database.ref(`admins/${newAdminId}`).once('value').then((snapshot) => {  
                if (snapshot.exists()) {  
                    showToast('该工号已经是管理员', false);  
                    return;  
                }  
                
                // 检查该工号是否存在  
                database.ref(`users/${newAdminId}`).once('value').then((userSnapshot) => {  
                    if (!userSnapshot.exists()) {  
                        showToast('该工号尚未注册', false);  
                        return;  
                    }  
                    
                    // 添加到管理员列表  
                    database.ref(`admins/${newAdminId}`).set(true)  
                        .then(() => {  
                            document.getElementById('newAdminId').value = '';  
                            showToast(`已将工号 ${newAdminId} 设为管理员`);  
                            
                            // 更新该工号发布的所有内容的管理员状态  
                            updateUserContentAdminStatusByEmployeeId(newAdminId, true);  
                        })  
                        .catch(error => {  
                            console.error('添加管理员失败:', error);  
                            showToast('添加管理员失败: ' + error.message, false);  
                        });  
                });  
            });  
        }  
        
        // 移除管理员  
        function removeAdmin(adminId) {  
            if (!isAdmin) {  
                showToast('只有管理员可以移除其他管理员', false);  
                return;  
            }  
            
            // 检查是否是最后一个管理员  
            database.ref('admins').once('value').then((snapshot) => {  
                const adminCount = Object.keys(snapshot.val() || {}).length;  
                
                if (adminCount <= 1) {  
                    showToast('无法移除最后一个管理员', false);  
                    return;  
                }  
                
                // 从管理员列表中移除  
                database.ref(`admins/${adminId}`).remove()  
                    .then(() => {  
                        showToast(`已移除管理员 ${adminId}`);  
                        
                        // 更新该工号发布的所有内容的管理员状态  
                        updateUserContentAdminStatusByEmployeeId(adminId, false);  
                    })  
                    .catch(error => {  
                        console.error('移除管理员失败:', error);  
                        showToast('移除管理员失败: ' + error.message, false);  
                    });  
            });  
        }  
        
        // 显示管理员面板  
        function showAdminPanel() {  
            if (!isAdmin) {  
                showToast('只有管理员可以访问设置', false);  
                return;  
            }  
            
            document.getElementById('mainContainer').classList.add('hidden');  
            document.getElementById('adminPanelContainer').classList.remove('hidden');  
            
            // 加载最新管理员列表  
            database.ref('admins').once('value').then(updateAdminList);  
        }  
        
        // 隐藏管理员面板  
        function hideAdminPanel() {  
            document.getElementById('adminPanelContainer').classList.add('hidden');  
            document.getElementById('mainContainer').classList.remove('hidden');  
        }  
        
        // 检查并更新当前用户的管理员状态  
        function checkAndUpdateAdminStatus() {  
            if (!currentUser) return;  
            
            database.ref(`admins/${currentUser.employee_id}`).once('value').then((snapshot) => {  
                isAdmin = snapshot.exists();  
                
                // 更新UI  
                updateAdminUI();  
                
                // 如果用户已经发布过帖子或回复，也更新这些内容中的管理员状态  
                if (isAdmin !== currentUser.is_admin) {  
                    updateUserContentAdminStatus();  
                    
                    // 更新currentUser对象  
                    currentUser.is_admin = isAdmin;  
                }  
            });  
        }  
        
        // 更新管理员UI显示  
        function updateAdminUI() {  
            // 导航栏管理员按钮  
            document.getElementById('adminPanelBtn').classList.toggle('hidden', !isAdmin);  
            
            // 个人资料中的管理员标识  
            document.getElementById('adminBadge').classList.toggle('hidden', !isAdmin);  
        }  
        
        // 更新用户发布内容中的管理员状态  
        function updateUserContentAdminStatus() {  
            if (!currentUser) return;  
            
            updateUserContentAdminStatusByEmployeeId(currentUser.employee_id, isAdmin);  
        }  
        
        // 根据工号更新用户发布内容中的管理员状态  
        function updateUserContentAdminStatusByEmployeeId(employeeId, isAdmin) {  
            // 更新帖子  
            database.ref('posts').orderByChild('author_employee_id').equalTo(employeeId).once('value')  
                .then((snapshot) => {  
                    snapshot.forEach((childSnapshot) => {  
                        childSnapshot.ref.update({ is_admin: isAdmin });  
                    });  
                });  
            
            // 更新回复  
            database.ref('replies').orderByChild('author_employee_id').equalTo(employeeId).once('value')  
                .then((snapshot) => {  
                    snapshot.forEach((childSnapshot) => {  
                        childSnapshot.ref.update({ is_admin: isAdmin });  
                    });  
                });  
        }  

        // 显示主要UI  
        function showMainUI() {  
            document.getElementById('loginContainer').classList.add('hidden');  
            document.getElementById('registerContainer').classList.add('hidden');  
            document.getElementById('userInfoContainer').classList.add('hidden');  
            document.getElementById('adminPanelContainer').classList.add('hidden');  
            document.getElementById('mainContainer').classList.remove('hidden');  
            document.getElementById('userNav').classList.remove('hidden');  
            
            // 更新导航栏用户信息  
            document.getElementById('navUserName').textContent = currentUser.name;  
            if (currentUser.avatar_url) {  
                document.getElementById('navUserAvatar').src = currentUser.avatar_url;  
            }  
            
            // 更新用户个人信息  
            document.getElementById('profileName').textContent = currentUser.name;  
            document.getElementById('profileEmployeeId').textContent = currentUser.employee_id;  
            if (currentUser.avatar_url) {  
                document.getElementById('profileAvatar').src = currentUser.avatar_url;  
            }  
            
            // 显示管理员标识和按钮  
            updateAdminUI();  
        }  

        // 生成唯一ID  
        function generateId() {  
            return Date.now().toString(36) + Math.random().toString(36).substr(2);  
        }  

        // 设置实时监听 - 修复了重复问题  
        function setupRealTimeListeners() {  
            if (postsInitialized) return; // 避免重复设置监听器  
            
            postsInitialized = true;  
            
            // 监听帖子变化  
            database.ref('posts').on('value', (snapshot) => {  
                console.log('收到帖子更新');  
                renderPosts(snapshot);  
            });  
            
            // 监听回复变化  
            database.ref('replies').on('value', (snapshot) => {  
                console.log('收到回复更新');  
                updateAllReplies(snapshot);  
            });  
        }  

        // 图片压缩功能  
        function compressImage(file) {  
            return new Promise((resolve) => {  
                const reader = new FileReader();  
                reader.onload = function(event) {  
                    const img = new Image();  
                    img.onload = function() {  
                        // 创建一个canvas元素  
                        const canvas = document.createElement('canvas');  
                        
                        // 计算新尺寸 (最大800px)  
                        let width = img.width;  
                        let height = img.height;  
                        const maxSize = 800;  
                        
                        if (width > height && width > maxSize) {  
                            height = Math.round(height * maxSize / width);  
                            width = maxSize;  
                        } else if (height > maxSize) {  
                            width = Math.round(width * maxSize / height);  
                            height = maxSize;  
                        }  
                        
                        // 设置canvas大小  
                        canvas.width = width;  
                        canvas.height = height;  
                        
                        // 绘制压缩后的图片  
                        const ctx = canvas.getContext('2d');  
                        ctx.drawImage(img, 0, 0, width, height);  
                        
                        // 转换为Blob  
                        canvas.toBlob(function(blob) {  
                            resolve(new File([blob], file.name || 'image.jpg', {  
                                type: 'image/jpeg',  
                                lastModified: Date.now()  
                            }));  
                        }, 'image/jpeg', 0.7); // 质量设为0.7  
                    };  
                    img.src = event.target.result;  
                };  
                reader.readAsDataURL(file);  
            });  
        }  

        // 简化版图片上传函数  
        async function uploadImageToImgBB(file) {  
            const IMGBB_API_KEY = 'b770ca69f1c22b4cd384bdf5bd18d5e2'; // 替换为您的实际API密钥  
            
            try {  
                // 如果有API密钥，尝试上传到ImgBB  
                if (IMGBB_API_KEY) {  
                    const formData = new FormData();  
                    formData.append('image', file);  
                    formData.append('key', IMGBB_API_KEY);  
                    
                    const response = await fetch('https://api.imgbb.com/1/upload', {  
                        method: 'POST',  
                        body: formData  
                    });  
                    
                    const data = await response.json();  
                    
                    if (data.success) {  
                        return data.data.url;  
                    }  
                }  
                
                // 回退到数据URL  
                return new Promise((resolve) => {  
                    const reader = new FileReader();  
                    reader.onloadend = () => resolve(reader.result);  
                    reader.readAsDataURL(file);  
                });  
            } catch (error) {  
                console.error('图片上传错误:', error);  
                
                // 错误情况下回退到数据URL  
                return new Promise((resolve) => {  
                    const reader = new FileReader();  
                    reader.onloadend = () => resolve(reader.result);  
                    reader.readAsDataURL(file);  
                });  
            }  
        }  

        // 创建帖子   
        async function createPost(section) {  
            if (!currentUser) {  
                showToast('请先登录', false);  
                return;  
            }  
            
            const contentElem = document.getElementById(`${section}PostContent`);  
            const imageElem = document.getElementById(`${section}PostImage`);  
            const content = contentElem.value.trim();  
            const imageFile = imageElem.files[0];  
            
            if (!content) {  
                showToast('请输入内容', false);  
                return;  
            }  
            
            showLoading(true);  
            
            try {  
                let imageUrl = null;  
                
                // 如果有图片，处理并上传  
                if (imageFile) {  
                    const compressedFile = await compressImage(imageFile);  
                    imageUrl = await uploadImageToImgBB(compressedFile);  
                }  
                
                // 创建帖子对象  
                const postId = generateId();  
                const newPost = {  
                    id: postId,  
                    author_name: currentUser.name,  
                    author_employee_id: currentUser.employee_id,  
                    author_avatar: currentUser.avatar_url,  
                    content: content,  
                    image_url: imageUrl,  
                    section: section,  
                    is_admin: isAdmin,  
                    likes: 0,  
                    created_at: new Date().toISOString()  
                };  
                
                // 保存到Firebase  
                await database.ref('posts/' + postId).set(newPost);  
                
                contentElem.value = '';  
                imageElem.value = '';  
                showToast('发布成功');  
            } catch (error) {  
                console.error('发布失败:', error);  
                showToast('发布失败: ' + error.message, false);  
            } finally {  
                showLoading(false);  
            }  
        }  
        
        // 渲染帖子  
        function renderPosts(snapshot) {  
            showLoading(true);  
            
            try {  
                // 清空现有帖子  
                document.getElementById('techPosts').innerHTML = '';  
                document.getElementById('dailyPosts').innerHTML = '';  
                document.getElementById('userPosts').innerHTML = '';  
                
                const posts = [];  
                snapshot.forEach((childSnapshot) => {  
                    posts.push(childSnapshot.val());  
                });  
                
                // 按创建时间排序，最新的在前面  
                posts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));  
                
                // 渲染到各个板块  
                posts.forEach(post => {  
                    const postElement = createPostElement(post);  
                    
                    if (post.section === 'tech') {  
                        document.getElementById('techPosts').appendChild(postElement.cloneNode(true));  
                    } else if (post.section === 'daily') {  
                        document.getElementById('dailyPosts').appendChild(postElement.cloneNode(true));  
                    }  
                    
                    // 如果是当前用户的帖子，也添加到用户板块  
                    if (currentUser && post.author_employee_id === currentUser.employee_id) {  
                        document.getElementById('userPosts').appendChild(postElement);  
                    }  
                });  
                
                // 添加事件  
                attachPostEvents();  
                
                // 更新所有回复状态  
                database.ref('replies').once('value').then(updateAllReplies);  
                
            } catch (error) {  
                console.error('渲染帖子出错:', error);  
                showToast('加载帖子出错', false);  
            } finally {  
                showLoading(false);  
            }  
        }  

        // 简化的创建帖子DOM元素函数  
        function createPostElement(post) {  
            const template = document.getElementById('postTemplate');  
            const postElement = template.content.cloneNode(true).querySelector('.post');  
            
            // 设置帖子ID  
            postElement.dataset.id = post.id;  
            
            // 设置作者信息  
            const avatarElem = postElement.querySelector('.post-avatar');  
            if (post.author_avatar) {  
                avatarElem.src = post.author_avatar;  
            }  
            
            postElement.querySelector('.post-author').textContent = post.author_name;  
            
            // 显示管理员标识  
            if (post.is_admin) {  
                postElement.querySelector('.post-admin-badge').classList.remove('hidden');  
            }  
            
            // 设置发布时间  
            const date = new Date(post.created_at);  
            postElement.querySelector('.post-time').textContent = date.toLocaleString();  
            
            // 设置内容  
            postElement.querySelector('.post-content').textContent = post.content;  
            
            // 简化的图片显示逻辑  
            if (post.image_url) {  
                const imageContainer = postElement.querySelector('.post-image-container');  
                const imageElem = postElement.querySelector('.post-image');  
                imageContainer.classList.remove('hidden');  
                imageElem.src = post.image_url;  
            }  
            
            // 设置点赞数  
            postElement.querySelector('.like-count').textContent = post.likes || 0;  
            
            // 如果是当前用户的帖子或管理员，显示删除按钮  
            if (currentUser && (post.author_employee_id === currentUser.employee_id || isAdmin)) {  
                postElement.querySelector('.delete-btn').classList.remove('hidden');  
            }  
            
            return postElement;  
        }  

        // 附加帖子事件（点赞、删除、回复）  
        function attachPostEvents() {  
            // 点赞事件  
            document.querySelectorAll('.like-btn').forEach(btn => {  
                btn.addEventListener('click', event => {  
                    if (!currentUser) return;  
                    
                    const postElement = event.currentTarget.closest('.post');  
                    const postId = postElement.dataset.id;  
                    
                    // 更新Firebase中的点赞数  
                    database.ref(`posts/${postId}/likes`).transaction((likes) => {  
                        return (likes || 0) + 1;  
                    });  
                });  
            });  
            
            // 删除事件  
            document.querySelectorAll('.delete-btn').forEach(btn => {  
                btn.addEventListener('click', event => {  
                    if (!currentUser) return;  
                    
                    const postElement = event.currentTarget.closest('.post');  
                    const postId = postElement.dataset.id;  
                    
                    if (confirm('确定要删除这条帖子吗？')) {  
                        // 从Firebase删除帖子  
                        database.ref(`posts/${postId}`).remove()  
                            .then(() => {  
                                showToast('删除成功');  
                                
                                // 同时删除所有相关回复  
                                database.ref('replies').orderByChild('post_id').equalTo(postId).once('value', (snapshot) => {  
                                    snapshot.forEach((childSnapshot) => {  
                                        childSnapshot.ref.remove();  
                                    });  
                                });  
                            })
                             .catch(error => {  
                                console.error('删除失败:', error);  
                                showToast('删除失败', false);  
                            });  
                    }  
                });  
            });  
            
            // 回复按钮事件  
            document.querySelectorAll('.reply-btn').forEach(btn => {  
                btn.addEventListener('click', event => {  
                    if (!currentUser) {  
                        showToast('请先登录', false);  
                        return;  
                    }  
                    
                    const postElement = event.currentTarget.closest('.post');  
                    const repliesSection = postElement.querySelector('.replies-section');  
                    
                    // 切换回复区域显示/隐藏  
                    if (repliesSection.classList.contains('hidden')) {  
                        repliesSection.classList.remove('hidden');  
                        
                        // 立即加载此帖子的所有回复  
                        loadRepliesForPost(postElement.dataset.id);  
                    } else {  
                        repliesSection.classList.add('hidden');  
                    }  
                });  
            });  
            
            // 发送回复事件  
            document.querySelectorAll('.send-reply-btn').forEach(btn => {  
                btn.addEventListener('click', event => {  
                    if (!currentUser) return;  
                    
                    const postElement = event.currentTarget.closest('.post');  
                    const postId = postElement.dataset.id;  
                    const replyInput = postElement.querySelector('.reply-input');  
                    const content = replyInput.value.trim();  
                    
                    if (!content) {  
                        showToast('请输入回复内容', false);  
                        return;  
                    }  
                    
                    // 创建回复对象  
                    const replyId = generateId();  
                    const newReply = {  
                        id: replyId,  
                        post_id: postId,  
                        author_name: currentUser.name,  
                        author_employee_id: currentUser.employee_id,  
                        author_avatar: currentUser.avatar_url,  
                        content: content,  
                        is_admin: isAdmin,  
                        created_at: new Date().toISOString()  
                    };  
                    
                    // 保存到Firebase  
                    database.ref('replies/' + replyId).set(newReply)  
                        .then(() => {  
                            replyInput.value = '';  
                            showToast('回复成功');  
                        })  
                        .catch(error => {  
                            console.error('回复失败:', error);  
                            showToast('回复失败: ' + error.message, false);  
                        });  
                });  
            });  
        }  

        // 加载特定帖子的回复  
        function loadRepliesForPost(postId) {  
            const postElements = document.querySelectorAll(`.post[data-id="${postId}"]`);  
            
            database.ref('replies').orderByChild('post_id').equalTo(postId).once('value', (snapshot) => {  
                const replies = [];  
                snapshot.forEach((childSnapshot) => {  
                    replies.push(childSnapshot.val());  
                });  
                
                // 按创建时间排序  
                replies.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));  
                
                postElements.forEach(postElement => {  
                    const repliesContainer = postElement.querySelector('.replies-container');  
                    repliesContainer.innerHTML = '';  
                    
                    if (replies.length === 0) {  
                        repliesContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">暂无回复</p>';  
                    } else {  
                        replies.forEach(reply => {  
                            repliesContainer.appendChild(createReplyElement(reply));  
                        });  
                    }  
                });  
                
                // 添加删除回复事件  
                attachReplyEvents();  
            });  
        }  
        
        // 更新所有回复  
        function updateAllReplies(snapshot) {  
            // 获取所有回复数据  
            const allReplies = {};  
            snapshot.forEach(childSnapshot => {  
                const reply = childSnapshot.val();  
                if (!allReplies[reply.post_id]) {  
                    allReplies[reply.post_id] = [];  
                }  
                allReplies[reply.post_id].push(reply);  
            });  
            
            // 更新每个帖子的回复显示  
            for (const postId in allReplies) {  
                const postElements = document.querySelectorAll(`.post[data-id="${postId}"]`);  
                
                // 按创建时间排序  
                allReplies[postId].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));  
                
                postElements.forEach(postElement => {  
                    // 只有回复区域已经展开的帖子才更新回复  
                    const repliesSection = postElement.querySelector('.replies-section');  
                    if (!repliesSection.classList.contains('hidden')) {  
                        const repliesContainer = postElement.querySelector('.replies-container');  
                        repliesContainer.innerHTML = '';  
                        
                        allReplies[postId].forEach(reply => {  
                            repliesContainer.appendChild(createReplyElement(reply));  
                        });  
                    }  
                });  
            }  
            
            // 添加回复事件  
            attachReplyEvents();  
        }  
        
        // 创建回复元素  
        function createReplyElement(reply) {  
            const template = document.getElementById('replyTemplate');  
            const replyElement = template.content.cloneNode(true).querySelector('.reply');  
            
            // 设置回复ID  
            replyElement.dataset.id = reply.id;  
            
            // 设置作者信息  
            const avatarElem = replyElement.querySelector('.reply-avatar');  
            if (reply.author_avatar) {  
                avatarElem.src = reply.author_avatar;  
            }  
            
            replyElement.querySelector('.reply-author').textContent = reply.author_name;  
            
            // 显示管理员标识  
            if (reply.is_admin) {  
                replyElement.querySelector('.reply-admin-badge').classList.remove('hidden');  
            }  
            
            // 设置发布时间  
            const date = new Date(reply.created_at);  
            replyElement.querySelector('.reply-time').textContent = date.toLocaleString();  
            
            // 设置内容  
            replyElement.querySelector('.reply-content').textContent = reply.content;  
            
            // 如果是当前用户的回复或管理员，显示删除按钮  
            if (currentUser && (reply.author_employee_id === currentUser.employee_id || isAdmin)) {  
                replyElement.querySelector('.delete-reply-btn').classList.remove('hidden');  
            }  
            
            return replyElement;  
        }  
        
        // 添加回复相关事件  
        function attachReplyEvents() {  
            // 删除回复事件  
            document.querySelectorAll('.delete-reply-btn').forEach(btn => {  
                btn.addEventListener('click', event => {  
                    if (!currentUser) return;  
                    
                    const replyElement = event.currentTarget.closest('.reply');  
                    const replyId = replyElement.dataset.id;  
                    
                    if (confirm('确定要删除这条回复吗？')) {  
                        // 从Firebase删除回复  
                        database.ref(`replies/${replyId}`).remove()  
                            .then(() => {  
                                showToast('删除回复成功');  
                            })  
                            .catch(error => {  
                                console.error('删除回复失败:', error);  
                                showToast('删除回复失败', false);  
                            });  
                    }  
                });  
            });  
        }  

        // 更新头像  
        async function updateAvatar() {  
            if (!currentUser || !document.getElementById('avatarInput').files.length) return;  
            
            showLoading(true);  
            
            try {  
                const file = document.getElementById('avatarInput').files[0];  
                const compressedFile = await compressImage(file);  
                const avatarUrl = await uploadImageToImgBB(compressedFile);  
                
                if (!avatarUrl) {  
                    showToast('头像上传失败', false);  
                    return;  
                }  
                
                // 更新用户数据中的头像  
                await database.ref(`users/${currentUser.employee_id}`).update({  
                    avatar_url: avatarUrl  
                });  
                
                // 更新当前用户头像  
                currentUser.avatar_url = avatarUrl;  
                
                // 更新UI  
                document.getElementById('profileAvatar').src = avatarUrl;  
                document.getElementById('navUserAvatar').src = avatarUrl;  
                showToast('头像更新成功');  
                
                // 更新该用户发布的所有帖子中的头像  
                updatePostsWithNewAvatar(avatarUrl);  
                
                // 更新该用户发布的所有回复中的头像  
                updateRepliesWithNewAvatar(avatarUrl);  
            } catch (error) {  
                console.error('更新头像失败:', error);  
                showToast('更新头像失败', false);  
            } finally {  
                showLoading(false);  
            }  
        }  
        
        // 更新用户所有帖子中的头像  
        function updatePostsWithNewAvatar(newAvatarUrl) {  
            if (!currentUser) return;  
            
            // 获取该用户的所有帖子  
            database.ref('posts').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')  
                .then((snapshot) => {  
                    snapshot.forEach((childSnapshot) => {  
                        // 更新每个帖子的作者头像  
                        childSnapshot.ref.update({ author_avatar: newAvatarUrl });  
                    });  
                });  
        }  
        
        // 更新用户所有回复中的头像  
        function updateRepliesWithNewAvatar(newAvatarUrl) {  
            if (!currentUser) return;  
            
            // 获取该用户的所有回复  
            database.ref('replies').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')  
                .then((snapshot) => {  
                    snapshot.forEach((childSnapshot) => {  
                        // 更新每个回复的作者头像  
                        childSnapshot.ref.update({ author_avatar: newAvatarUrl });  
                    });  
                });  
        }  
        
        // 更新用户所有帖子中的姓名  
        function updatePostsWithNewName(newName) {  
            if (!currentUser) return;  
            
            // 获取该用户的所有帖子  
            database.ref('posts').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')  
                .then((snapshot) => {  
                    snapshot.forEach((childSnapshot) => {  
                        // 更新每个帖子的作者姓名  
                        childSnapshot.ref.update({ author_name: newName });  
                    });  
                });  
        }  
        
        // 更新用户所有回复中的姓名  
        function updateRepliesWithNewName(newName) {  
            if (!currentUser) return;  
            
            // 获取该用户的所有回复  
            database.ref('replies').orderByChild('author_employee_id').equalTo(currentUser.employee_id).once('value')  
                .then((snapshot) => {  
                    snapshot.forEach((childSnapshot) => {  
                        // 更新每个回复的作者姓名  
                        childSnapshot.ref.update({ author_name: newName });  
                    });  
                });  
        }  

        // 添加初始帖子（如果Firebase为空）  
        function addInitialPostsIfNeeded() {  
            database.ref('posts').once('value').then((snapshot) => {  
                if (!snapshot.exists()) {  
                    console.log('数据库为空，添加初始帖子');  
                    // 数据库为空，添加初始帖子  
                    const initialPosts = {  
                        "init1": {  
                            id: "init1",  
                            author_name: "系统管理员",  
                            author_employee_id: "admin001",  
                            author_avatar: "https://via.placeholder.com/100",  
                            content: "欢迎使用青年π空间！这是一个技术问题示例帖子。",  
                            section: "tech",  
                            is_admin: true,  
                            likes: 0,  
                            created_at: new Date().toISOString()  
                        },  
                        "init2": {  
                            id: "init2",  
                            author_name: "系统管理员",  
                            author_employee_id: "admin001",  
                            author_avatar: "https://via.placeholder.com/100",  
                            content: "在这里可以分享日常问题和交流。",  
                            section: "daily",  
                            is_admin: true,  
                            likes: 0,  
                            created_at: new Date().toISOString()  
                        }  
                    };  
                    
                    database.ref('posts').set(initialPosts);  
                    
                    // 初始化默认管理员账户数据  
                    const adminUser = {  
                        id: generateId(),  
                        name: "系统管理员",  
                        employee_id: "admin001",  
                        password_hash: hashPassword("admin123"), // 默认密码  
                        avatar_url: "https://via.placeholder.com/100",  
                        is_admin: true,  
                        created_at: new Date().toISOString()  
                    };  
                    
                    database.ref('users/admin001').set(adminUser);  
                }  
            });  
        }  
    </script>  
</body>  
</html>  
