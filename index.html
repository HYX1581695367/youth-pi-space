
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è£…å¤‡éƒ¨ä»¶å›¢æ”¯éƒ¨é’å¹´Ï€ç©ºé—´</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  background: #f7f9fc;
  color: #222;
}
header {
  background: #4e73df;
  color: white;
  padding: 10px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
nav button {
  background: #f8f9fc;
  color: #333;
  border: none;
  margin: 2px 5px;
  padding: 8px 10px;
  border-radius: 4px;
  cursor: pointer;
}
nav button:hover {
  background: #dce1f7;
}
.hidden { display: none; }
.container {
  padding: 15px;
}
.post {
  background: white;
  margin: 10px 0;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.reply {
  background: #f2f4f8;
  margin: 5px;
  padding: 5px 10px;
  border-radius: 3px;
}
.badge {
  background: #ffcc00;
  color: #333;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 12px;
  margin-left: 6px;
}
.scoreboard {
  background: white;
  border-radius: 5px;
  padding: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
table {
  width: 100%;
  border-collapse: collapse;
}
table th, table td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  text-align: left;
}
.highlight {
  background: #fff3cd;
}
button.excellent {
  background-color: #ffc107;
  color: #333;
}
</style>
</head>

<body>
<header>
  <div><strong>è£…å¤‡éƒ¨ä»¶å›¢æ”¯éƒ¨é’å¹´Ï€ç©ºé—´</strong></div>
  <nav>
    <button id="nav-home">é¦–é¡µ</button>
    <button id="nav-tech">æŠ€æœ¯é—®é¢˜</button>
    <button id="nav-daily">æ—¥å¸¸é—®é¢˜</button>
    <button id="nav-points">ç§¯åˆ†æ¦œ</button>
    <button id="nav-profile">ä¸ªäººä¸­å¿ƒ</button>
    <button id="logoutBtn">é€€å‡º</button>
  </nav>
</header>

<div class="container" id="content"></div>

<script type="module">
// ============ Firebase åˆå§‹åŒ– ===============
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, setDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// =============== å…¨å±€çŠ¶æ€ ==================
let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;

// =============== å·¥å…·å‡½æ•° =================
async function modifyPoints(userId, delta) {
  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const data = snap.data();
    const newPoints = (data.points || 0) + delta;
    await updateDoc(ref, { points: newPoints });
    if (currentUser && currentUser.id === userId) {
      currentUser.points = newPoints;
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
    }
  }
}

// =============== é¡µé¢ç»„ä»¶ =================
async function renderHome() {
  document.getElementById('content').innerHTML = `
    <h2>æ¬¢è¿å›æ¥ï¼Œ${currentUser.name}</h2>
    <p>è¯·é€‰æ‹©ä¸Šæ–¹æ¿å—æµè§ˆå¸–å­æˆ–å‘å¸ƒæ–°å†…å®¹ã€‚</p>
  `;
}

async function renderProfile() {
  const ref = doc(db, "users", currentUser.id);
  const s = await getDoc(ref);
  if (s.exists()) {
    currentUser = { ...s.data(), id: currentUser.id };
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
  }
  const today = new Date().toISOString().split('T')[0];
  const checkedIn = currentUser.lastCheckInDate === today;
  document.getElementById('content').innerHTML = `
    <h2>ä¸ªäººä¸­å¿ƒ</h2>
    <p><strong>å§“åï¼š</strong>${currentUser.name}</p>
    <p><strong>å·¥å·ï¼š</strong>${currentUser.jobId}</p>
    <p><strong>è§’è‰²ï¼š</strong>${currentUser.role}</p>
    <p><strong>å½“å‰ç§¯åˆ†ï¼š</strong>${currentUser.points || 0}</p>
    <button id="checkInBtn" ${checkedIn ? "disabled" : ""}>${checkedIn ? "ä»Šæ—¥å·²ç­¾åˆ°" : "ç­¾åˆ° +5"}</button>
  `;
  document.getElementById('checkInBtn').onclick = async () => {
    const today = new Date().toISOString().split('T')[0];
    if (currentUser.lastCheckInDate === today) {
      alert("ä»Šæ—¥å·²ç­¾åˆ°");
      return;
    }
    await modifyPoints(currentUser.id, 5);
    await updateDoc(ref, { lastCheckInDate: today });
    alert("ç­¾åˆ°æˆåŠŸ +5 åˆ†ï¼");
    renderProfile();
  };
}

async function renderPointsBoard() {
  const q = collection(db, "users");
  const snap = await getDocs(q);
  let users = [];
  snap.forEach(d => users.push({id:d.id, ...d.data()}));
  users.sort((a,b)=> (b.points||0)-(a.points||0));
  const rows = users.map(u=>`
    <tr ${currentUser.id===u.id?'class="highlight"':''}>
      <td>${u.name}</td>
      <td>${u.jobId}</td>
      <td>${u.role}</td>
      <td>${u.points || 0}</td>
    </tr>`).join('');
  document.getElementById('content').innerHTML = `
    <h2>ğŸ… ç§¯åˆ†æ¦œ</h2>
    <div class="scoreboard">
      <table>
        <thead><tr><th>å§“å</th><th>å·¥å·</th><th>è§’è‰²</th><th>ç§¯åˆ†</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function renderBoard(boardType) {
  const q = query(collection(db, "posts"), where("board", "==", boardType), orderBy("timestamp", "desc"));
  const snap = await getDocs(q);
  let posts = [];
  snap.forEach(d=> posts.push({id:d.id, ...d.data()}));
  let html = `<h2>${boardType==="tech"?"æŠ€æœ¯é—®é¢˜":"æ—¥å¸¸é—®é¢˜"}</h2>
  <button id="newPost">å‘å¸ƒå¸–å­</button>`;
  posts.sort((a,b)=>{
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    return b.timestamp - a.timestamp;
  });
  for (const p of posts) {
    html += `
    <div class="post">
      <p><strong>${p.authorName}</strong> ${p.role==="admin"||p.role==="sysadmin"?'<span class="badge">ç®¡ç†å‘˜</span>':''}
      ${p.excellent?'<span class="badge">ä¼˜ç§€å¸–</span>':''}</p>
      <p>${p.content}</p>
      <button data-id="${p.id}" class="likeBtn">ğŸ‘${p.likes||0}</button>
      ${currentUser.role==="admin" || currentUser.role==="sysadmin"
        ?`<button data-id="${p.id}" class="excellent">è®¾ä¸ºä¼˜ç§€</button>`:""}
    </div>`;
  }
  document.getElementById('content').innerHTML = html;
  document.querySelectorAll('.excellent').forEach(btn=>{
    btn.onclick = async ()=>{
      const id=btn.dataset.id;
      const postRef=doc(db,"posts",id);
      const snap=await getDoc(postRef);
      if(!snap.exists())return;
      const postData=snap.data();
      if(postData.excellent) {alert("å·²æ˜¯ä¼˜ç§€å¸–");return;}
      await updateDoc(postRef,{excellent:true});
      await modifyPoints(postData.authorId,10);
      alert("æ ‡è®°ä¸ºä¼˜ç§€å¸–å¹¶å¥–åŠ±ä½œè€…+10åˆ†");
      renderBoard(boardType);
    }
  });
  document.getElementById('newPost').onclick = async ()=>{
    const content=prompt("è¯·è¾“å…¥å¸–å­å†…å®¹ï¼š");
    if(!content)return;
    const newPost={
      content, board:boardType,
      authorId:currentUser.id,
      authorName:currentUser.name,
      role:currentUser.role,
      likes:0,
      pinned:false,
      excellent:false,
      timestamp:Date.now()
    };
    await addDoc(collection(db,"posts"), newPost);
    await modifyPoints(currentUser.id,10);
    alert("å‘å¸–æˆåŠŸ +10åˆ†ï¼");
    renderBoard(boardType);
  };
}

// =============== åˆå§‹åŒ–ç»‘å®š ===============
document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("currentUser");
  location.reload();
};
document.getElementById("nav-home").onclick = renderHome;
document.getElementById("nav-profile").onclick = renderProfile;
document.getElementById("nav-points").onclick = renderPointsBoard;
document.getElementById("nav-tech").onclick = ()=>renderBoard("tech");
document.getElementById("nav-daily").onclick = ()=>renderBoard("daily");

// =============== å¯åŠ¨é€»è¾‘ ===============
if (!currentUser) {
  document.getElementById('content').innerHTML = `
  <h2>è¯·ç™»å½•</h2>
  <p>å·¥å·ï¼š<input id="jobId" /></p>
  <p>å¯†ç ï¼š<input id="pwd" type="password" /></p>
  <button id="loginBtn">ç™»å½•</button>
  `;
  document.getElementById('loginBtn').onclick = async ()=>{
    const jobId=document.getElementById('jobId').value.trim();
    const pwd=document.getElementById('pwd').value.trim();
    if(!jobId||!pwd)return alert("è¯·è¾“å…¥è´¦å·å¯†ç ");
    const usersSnap=await getDocs(collection(db,"users"));
    let userFound=null;
    usersSnap.forEach(d=>{
      const u=d.data();
      if(u.jobId===jobId && u.password===pwd) userFound={id:d.id,...u};
    });
    if(!userFound) return alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
    userFound.expire=Date.now()+24*3600*1000;
    localStorage.setItem("currentUser",JSON.stringify(userFound));
    currentUser=userFound;
    renderHome();
  };
}else{
  if(Date.now()>currentUser.expire){
    localStorage.removeItem("currentUser");
    alert("ä¼šè¯è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
    location.reload();
  } else {
    renderHome();
  }
}
</script>
</body>
</html>
