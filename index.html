
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>装备部件团支部青年π空间</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  margin: 0;
  background: #f7f9fc;
  color: #222;
}
header {
  background: #4e73df;
  color: white;
  padding: 10px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
nav button {
  background: #f8f9fc;
  color: #333;
  border: none;
  margin: 2px 5px;
  padding: 8px 10px;
  border-radius: 4px;
  cursor: pointer;
}
nav button:hover {
  background: #dce1f7;
}
.hidden { display: none; }
.container {
  padding: 15px;
}
.post {
  background: white;
  margin: 10px 0;
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.reply {
  background: #f2f4f8;
  margin: 5px;
  padding: 5px 10px;
  border-radius: 3px;
}
.badge {
  background: #ffcc00;
  color: #333;
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 12px;
  margin-left: 6px;
}
.scoreboard {
  background: white;
  border-radius: 5px;
  padding: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
table {
  width: 100%;
  border-collapse: collapse;
}
table th, table td {
  padding: 8px;
  border-bottom: 1px solid #ddd;
  text-align: left;
}
.highlight {
  background: #fff3cd;
}
button.excellent {
  background-color: #ffc107;
  color: #333;
}
</style>
</head>

<body>
<header>
  <div><strong>装备部件团支部青年π空间</strong></div>
  <nav>
    <button id="nav-home">首页</button>
    <button id="nav-tech">技术问题</button>
    <button id="nav-daily">日常问题</button>
    <button id="nav-points">积分榜</button>
    <button id="nav-profile">个人中心</button>
    <button id="logoutBtn">退出</button>
  </nav>
</header>

<div class="container" id="content"></div>

<script type="module">
// ============ Firebase 初始化 ===============
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, setDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// =============== 全局状态 ==================
let currentUser = JSON.parse(localStorage.getItem("currentUser")) || null;

// =============== 工具函数 =================
async function modifyPoints(userId, delta) {
  const ref = doc(db, "users", userId);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const data = snap.data();
    const newPoints = (data.points || 0) + delta;
    await updateDoc(ref, { points: newPoints });
    if (currentUser && currentUser.id === userId) {
      currentUser.points = newPoints;
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
    }
  }
}

// =============== 页面组件 =================
async function renderHome() {
  document.getElementById('content').innerHTML = `
    <h2>欢迎回来，${currentUser.name}</h2>
    <p>请选择上方板块浏览帖子或发布新内容。</p>
  `;
}

async function renderProfile() {
  const ref = doc(db, "users", currentUser.id);
  const s = await getDoc(ref);
  if (s.exists()) {
    currentUser = { ...s.data(), id: currentUser.id };
    localStorage.setItem("currentUser", JSON.stringify(currentUser));
  }
  const today = new Date().toISOString().split('T')[0];
  const checkedIn = currentUser.lastCheckInDate === today;
  document.getElementById('content').innerHTML = `
    <h2>个人中心</h2>
    <p><strong>姓名：</strong>${currentUser.name}</p>
    <p><strong>工号：</strong>${currentUser.jobId}</p>
    <p><strong>角色：</strong>${currentUser.role}</p>
    <p><strong>当前积分：</strong>${currentUser.points || 0}</p>
    <button id="checkInBtn" ${checkedIn ? "disabled" : ""}>${checkedIn ? "今日已签到" : "签到 +5"}</button>
  `;
  document.getElementById('checkInBtn').onclick = async () => {
    const today = new Date().toISOString().split('T')[0];
    if (currentUser.lastCheckInDate === today) {
      alert("今日已签到");
      return;
    }
    await modifyPoints(currentUser.id, 5);
    await updateDoc(ref, { lastCheckInDate: today });
    alert("签到成功 +5 分！");
    renderProfile();
  };
}

async function renderPointsBoard() {
  const q = collection(db, "users");
  const snap = await getDocs(q);
  let users = [];
  snap.forEach(d => users.push({id:d.id, ...d.data()}));
  users.sort((a,b)=> (b.points||0)-(a.points||0));
  const rows = users.map(u=>`
    <tr ${currentUser.id===u.id?'class="highlight"':''}>
      <td>${u.name}</td>
      <td>${u.jobId}</td>
      <td>${u.role}</td>
      <td>${u.points || 0}</td>
    </tr>`).join('');
  document.getElementById('content').innerHTML = `
    <h2>🏅 积分榜</h2>
    <div class="scoreboard">
      <table>
        <thead><tr><th>姓名</th><th>工号</th><th>角色</th><th>积分</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

async function renderBoard(boardType) {
  const q = query(collection(db, "posts"), where("board", "==", boardType), orderBy("timestamp", "desc"));
  const snap = await getDocs(q);
  let posts = [];
  snap.forEach(d=> posts.push({id:d.id, ...d.data()}));
  let html = `<h2>${boardType==="tech"?"技术问题":"日常问题"}</h2>
  <button id="newPost">发布帖子</button>`;
  posts.sort((a,b)=>{
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    return b.timestamp - a.timestamp;
  });
  for (const p of posts) {
    html += `
    <div class="post">
      <p><strong>${p.authorName}</strong> ${p.role==="admin"||p.role==="sysadmin"?'<span class="badge">管理员</span>':''}
      ${p.excellent?'<span class="badge">优秀帖</span>':''}</p>
      <p>${p.content}</p>
      <button data-id="${p.id}" class="likeBtn">👍${p.likes||0}</button>
      ${currentUser.role==="admin" || currentUser.role==="sysadmin"
        ?`<button data-id="${p.id}" class="excellent">设为优秀</button>`:""}
    </div>`;
  }
  document.getElementById('content').innerHTML = html;
  document.querySelectorAll('.excellent').forEach(btn=>{
    btn.onclick = async ()=>{
      const id=btn.dataset.id;
      const postRef=doc(db,"posts",id);
      const snap=await getDoc(postRef);
      if(!snap.exists())return;
      const postData=snap.data();
      if(postData.excellent) {alert("已是优秀帖");return;}
      await updateDoc(postRef,{excellent:true});
      await modifyPoints(postData.authorId,10);
      alert("标记为优秀帖并奖励作者+10分");
      renderBoard(boardType);
    }
  });
  document.getElementById('newPost').onclick = async ()=>{
    const content=prompt("请输入帖子内容：");
    if(!content)return;
    const newPost={
      content, board:boardType,
      authorId:currentUser.id,
      authorName:currentUser.name,
      role:currentUser.role,
      likes:0,
      pinned:false,
      excellent:false,
      timestamp:Date.now()
    };
    await addDoc(collection(db,"posts"), newPost);
    await modifyPoints(currentUser.id,10);
    alert("发帖成功 +10分！");
    renderBoard(boardType);
  };
}

// =============== 初始化绑定 ===============
document.getElementById("logoutBtn").onclick = ()=>{
  localStorage.removeItem("currentUser");
  location.reload();
};
document.getElementById("nav-home").onclick = renderHome;
document.getElementById("nav-profile").onclick = renderProfile;
document.getElementById("nav-points").onclick = renderPointsBoard;
document.getElementById("nav-tech").onclick = ()=>renderBoard("tech");
document.getElementById("nav-daily").onclick = ()=>renderBoard("daily");

// =============== 启动逻辑 ===============
if (!currentUser) {
  document.getElementById('content').innerHTML = `
  <h2>请登录</h2>
  <p>工号：<input id="jobId" /></p>
  <p>密码：<input id="pwd" type="password" /></p>
  <button id="loginBtn">登录</button>
  `;
  document.getElementById('loginBtn').onclick = async ()=>{
    const jobId=document.getElementById('jobId').value.trim();
    const pwd=document.getElementById('pwd').value.trim();
    if(!jobId||!pwd)return alert("请输入账号密码");
    const usersSnap=await getDocs(collection(db,"users"));
    let userFound=null;
    usersSnap.forEach(d=>{
      const u=d.data();
      if(u.jobId===jobId && u.password===pwd) userFound={id:d.id,...u};
    });
    if(!userFound) return alert("账号或密码错误");
    userFound.expire=Date.now()+24*3600*1000;
    localStorage.setItem("currentUser",JSON.stringify(userFound));
    currentUser=userFound;
    renderHome();
  };
}else{
  if(Date.now()>currentUser.expire){
    localStorage.removeItem("currentUser");
    alert("会话过期，请重新登录");
    location.reload();
  } else {
    renderHome();
  }
}
</script>
</body>
</html>
